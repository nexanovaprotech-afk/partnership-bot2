<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partnership Calculator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--tg-theme-bg-color, #f7fafc);
            color: var(--tg-theme-text-color, #2d3748);
            padding: 0;
            margin: 0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
        }
        .header h1 { font-size: 1.4em; margin-bottom: 5px; }
        .header p { font-size: 0.9em; opacity: 0.9; }
        .input-box {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .input-box label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1em;
        }
        .input-box input {
            width: 100%;
            padding: 14px;
            font-size: 18px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-weight: bold;
        }
        .btn {
            width: 100%;
            padding: 16px;
            font-size: 1.1em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn:active { opacity: 0.8; }
        .split-box {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .split-box h3 {
            font-size: 1em;
            color: #667eea;
            margin-bottom: 10px;
        }
        .row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
        }
        .row .val { font-weight: bold; color: #667eea; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #764ba2;
        }
        .card .row .lab { color: #4a5568; font-size: 0.9em; }
        .card .row .val { font-weight: bold; }
        .history {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .history h3 {
            font-size: 1.1em;
            margin-bottom: 12px;
            color: #667eea;
        }
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
        }
        .history-item:last-child { border-bottom: none; }
        .history-item .time {
            color: #718096;
            font-size: 0.85em;
        }
        .history-item .amt {
            font-weight: bold;
            color: #667eea;
        }
        .totals {
            background: #edf2f7;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .totals .row {
            padding: 4px 0;
        }
        .success {
            background: #48bb78;
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ’¼ Partnership Calculator</h1>
            <p>Bhargav â€¢ Sagar â€¢ Bharat â€¢ Person X</p>
        </div>

        <div class="success" id="success">âœ… Payment recorded successfully!</div>

        <div class="totals">
            <div class="row">
                <span><strong>Total Debt Paid to X:</strong></span>
                <span class="val" id="totalDebt">â‚¹0</span>
            </div>
            <div class="row">
                <span><strong>Total Salary Paid:</strong></span>
                <span class="val" id="totalSalary">â‚¹0</span>
            </div>
        </div>

        <div class="input-box">
            <label>ðŸ’° Enter Payment Amount (â‚¹)</label>
            <input type="number" id="amt" value="10000" placeholder="Enter amount...">
            <button class="btn" onclick="recordPayment()">ðŸ’¾ Record Payment</button>
        </div>

        <div class="split-box">
            <h3>ðŸ“Š Current Payment Split</h3>
            <div class="row">
                <span>Total Payment:</span>
                <span class="val" id="tot">â‚¹10,000</span>
            </div>
            <div class="row">
                <span>To Person X (50%):</span>
                <span class="val" id="toX">â‚¹5,000</span>
            </div>
            <div class="row">
                <span>Salary Pool (50%):</span>
                <span class="val" id="sal">â‚¹5,000</span>
            </div>
        </div>

        <div class="card">
            <h3>ðŸ‘¤ Bhargav (A)</h3>
            <div class="row">
                <span class="lab">Debt Paid (46.28%):</span>
                <span class="val" id="ad">â‚¹2,314</span>
            </div>
            <div class="row">
                <span class="lab">Salary (13.72%):</span>
                <span class="val" id="as">â‚¹686</span>
            </div>
            <div class="row">
                <span class="lab">Remaining Debt:</span>
                <span class="val" id="ar">â‚¹68,500</span>
            </div>
        </div>

        <div class="card">
            <h3>ðŸ‘¤ Sagar (B)</h3>
            <div class="row">
                <span class="lab">Debt Paid (46.28%):</span>
                <span class="val" id="bd">â‚¹2,314</span>
            </div>
            <div class="row">
                <span class="lab">Salary (13.72%):</span>
                <span class="val" id="bs">â‚¹686</span>
            </div>
            <div class="row">
                <span class="lab">Remaining Debt:</span>
                <span class="val" id="br">â‚¹68,500</span>
            </div>
        </div>

        <div class="card">
            <h3>ðŸ‘¤ Bharat (C)</h3>
            <div class="row">
                <span class="lab">Debt Paid (7.43%):</span>
                <span class="val" id="cd">â‚¹372</span>
            </div>
            <div class="row">
                <span class="lab">Salary (72.57%):</span>
                <span class="val" id="cs">â‚¹3,628</span>
            </div>
            <div class="row">
                <span class="lab">Remaining Debt:</span>
                <span class="val" id="cr">â‚¹19,700</span>
            </div>
        </div>

        <div class="history">
            <h3>ðŸ“œ Recent Payments</h3>
            <div id="historyList">Loading...</div>
        </div>
    </div>

    <script>
        // Initialize Telegram WebApp
        var tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // API base URL - change this after deployment
        var API_URL = window.location.origin;

        // Format currency
        function fmt(val) {
            return 'â‚¹' + Math.round(val).toLocaleString('en-IN');
        }

        // Calculate preview
        function calc() {
            var p = parseFloat(document.getElementById('amt').value) || 0;
            var x = p * 0.5;
            var s = p * 0.5;

            document.getElementById('tot').innerHTML = fmt(p);
            document.getElementById('toX').innerHTML = fmt(x);
            document.getElementById('sal').innerHTML = fmt(s);

            document.getElementById('ad').innerHTML = fmt(x * 0.462837837837);
            document.getElementById('as').innerHTML = fmt(s * 0.137162162162);

            document.getElementById('bd').innerHTML = fmt(x * 0.462837837837);
            document.getElementById('bs').innerHTML = fmt(s * 0.137162162162);

            document.getElementById('cd').innerHTML = fmt(x * 0.0743243243243);
            document.getElementById('cs').innerHTML = fmt(s * 0.725675675675);
        }

        // Record payment to backend
        function recordPayment() {
            var amount = parseFloat(document.getElementById('amt').value);
            if (!amount || amount <= 0) {
                tg.showAlert('Please enter a valid amount');
                return;
            }

            var user = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : 'Unknown';

            fetch(API_URL + '/api/payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: amount, user: user })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    document.getElementById('success').style.display = 'block';
                    setTimeout(function() {
                        document.getElementById('success').style.display = 'none';
                    }, 3000);
                    loadState();
                    loadHistory();
                }
            })
            .catch(function(err) {
                tg.showAlert('Error: ' + err.message);
            });
        }

        // Load current state from backend
        function loadState() {
            fetch(API_URL + '/api/state')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                document.getElementById('totalDebt').innerHTML = fmt(data.totals.debtPaid);
                document.getElementById('totalSalary').innerHTML = fmt(data.totals.salaryPaid);

                // Calculate remaining debts
                var totalInit = data.debts.A + data.debts.B + data.debts.C || 1;
                var shareA = data.debts.A / totalInit;
                var shareB = data.debts.B / totalInit;
                var shareC = data.debts.C / totalInit;

                var aPaid = data.totals.debtPaid * shareA;
                var bPaid = data.totals.debtPaid * shareB;
                var cPaid = data.totals.debtPaid * shareC;

                document.getElementById('ar').innerHTML = fmt(Math.max(0, data.debts.A - aPaid));
                document.getElementById('br').innerHTML = fmt(Math.max(0, data.debts.B - bPaid));
                document.getElementById('cr').innerHTML = fmt(Math.max(0, data.debts.C - cPaid));
            });
        }

        // Load payment history
        function loadHistory() {
            fetch(API_URL + '/api/history?limit=10')
            .then(function(res) { return res.json(); })
            .then(function(payments) {
                var html = '';
                if (payments.length === 0) {
                    html = '<div style="text-align:center; color:#718096;">No payments yet</div>';
                } else {
                    payments.forEach(function(p) {
                        var date = new Date(p.timestamp);
                        var timeStr = date.toLocaleString('en-IN', { 
                            month: 'short', 
                            day: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        html += '<div class="history-item">';
                        html += '<div class="time">' + timeStr + ' â€¢ ' + p.user + '</div>';
                        html += '<div class="amt">' + fmt(p.amount) + '</div>';
                        html += '</div>';
                    });
                }
                document.getElementById('historyList').innerHTML = html;
            });
        }

        // Initialize
        document.getElementById('amt').addEventListener('input', calc);
        calc();
        loadState();
        loadHistory();
    </script>
</body>
</html>