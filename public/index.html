<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partnership Calculator - Final</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 0;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }

        .summary-row:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-label {
            font-weight: 600;
            color: #333;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .summary-value.remaining {
            color: #f44336;
            font-size: 20px;
        }

        .summary-value.complete {
            color: #28a745;
            font-size: 20px;
        }

        .input-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .input-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
            font-size: 15px;
        }

        input[type="number"], input[type="password"], input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
            color: #333;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            line-height: 1.5;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .date-range-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .date-range-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            margin: 0;
            margin-right: 8px;
        }

        .split-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .split-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 16px;
            font-size: 16px;
        }

        .split-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .split-row:last-child {
            border-bottom: none;
        }

        .split-label {
            color: #666;
        }

        .split-value {
            font-weight: 700;
            font-size: 16px;
            color: #333;
        }

        .partner-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .partner-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .partner-name {
            font-weight: 700;
            color: #333;
        }

        .partner-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
        }

        .partner-label {
            color: #666;
        }

        .partner-value {
            font-weight: 600;
            color: #333;
        }

        .partner-value.paid {
            color: #28a745;
        }

        .history-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .history-header {
            font-weight: 700;
            margin-bottom: 12px;
            color: #333;
            font-size: 18px;
        }

        .history-item {
            padding: 16px;
            background: #fafafa;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            position: relative;
        }

        .history-item.extra-payment {
            border-left: 4px solid #28a745;
            background: #f0fff4;
        }

        .history-item.new-debt {
            border-left: 4px solid #ff9800;
            background: #fff8e1;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-amount {
            font-weight: 700;
            font-size: 18px;
            color: #333;
        }

        .history-actions {
            display: flex;
            gap: 8px;
        }

        .history-split {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }

        .history-date-range {
            font-size: 13px;
            color: #667eea;
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #f0f4ff;
            border-radius: 6px;
            display: inline-block;
        }

        .history-comment {
            background: #fff;
            border-left: 3px solid #667eea;
            padding: 10px 12px;
            margin-top: 10px;
            border-radius: 6px;
            font-size: 14px;
            color: #555;
            font-style: italic;
        }

        .history-comment-icon {
            display: inline-block;
            margin-right: 6px;
            font-style: normal;
        }

        .history-partner-details {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 8px;
        }

        .history-partner-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 4px 0;
        }

        .history-meta {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        .alert {
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
            font-weight: 600;
            animation: slideIn 0.3s;
        }

        .alert-success {
            background: #4caf50;
            color: white;
        }

        .alert-error {
            background: #f44336;
            color: white;
        }

        .alert-info {
            background: #2196f3;
            color: white;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .admin-badge {
            display: inline-block;
            background: #ffd700;
            color: #333;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
        }

        .hidden {
            display: none !important;
        }

        .admin-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .admin-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin: 24px 0 16px 0;
            padding-left: 4px;
            border-left: 4px solid #667eea;
        }

        .fifty-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
        }

        .debt-complete-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
        }

        .debt-highlight {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .debt-highlight.complete {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .debt-highlight .label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .debt-highlight .value {
            font-size: 32px;
            font-weight: 700;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .config-input-group {
            display: flex;
            flex-direction: column;
        }

        .config-input-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
        }

        .config-input-group input {
            margin-bottom: 0;
        }

        .access-denied {
            background: white;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin-top: 40px;
        }

        .access-denied h2 {
            color: #f44336;
            margin-bottom: 16px;
        }

        .access-denied p {
            color: #666;
            margin-bottom: 24px;
        }

        .pending-users {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .pending-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .pending-user-info {
            flex: 1;
        }

        .pending-user-name {
            font-weight: 600;
            color: #333;
        }

        .pending-user-id {
            font-size: 12px;
            color: #999;
        }

        .pending-actions {
            display: flex;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #333;
        }

        .modal-body {
            margin-bottom: 16px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .monthly-selector {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .monthly-report {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }

        .monthly-summary {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .monthly-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .new-debt-badge {
            background: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
        }
    
        .partner-config-item {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 2px solid #e0e0e0;
        }

        .partner-config-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr auto;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .partner-config-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 4px;
        }

        .partner-config-input {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            background: white;
        }

        .partner-config-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-remove-partner {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }

        .partner-config-header {
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .share-total-info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            text-align: center;
            font-weight: 600;
            color: #1976d2;
        }

        .share-total-info.warning {
            background: #fff3cd;
            color: #856404;
        }

        .share-total-info.error {
            background: #f8d7da;
            color: #721c24;
        }
</style>
</head>
<body>
    <div class="header">
        <h1>
            √∞≈∏‚Äô¬º Partnership Calculator
            <span id="adminBadge" class="admin-badge hidden">ADMIN</span>
        </h1>
        <div class="subtitle">Final Version - Complete System</div>
    </div>

    <div class="container">
        <div id="alertContainer"></div>

        <!-- ACCESS REQUEST SECTION -->
        <div id="accessRequestSection" class="hidden">
            <div class="access-denied">
                <h2>√∞≈∏‚Äù‚Äô Access Required</h2>
                <p>This is a private partnership calculator. Please request access from the administrator.</p>
                <button class="btn btn-primary" onclick="requestAccess()">
                    √∞≈∏‚Äú¬® Request Access
                </button>
            </div>
        </div>

        <!-- PENDING ACCESS SECTION -->
        <div id="pendingAccessSection" class="hidden">
            <div class="access-denied">
                <h2>√¢¬è¬≥ Access Pending</h2>
                <p>Your access request has been sent to the administrator. Please wait for approval.</p>
                <button class="btn btn-secondary" onclick="checkAccessStatus()">
                    √∞≈∏‚Äù‚Äû Check Status
                </button>
            </div>
        </div>

        <!-- ADMIN LOGIN SECTION -->
        <div id="adminLoginSection" class="admin-section hidden">
            <div class="admin-title">√∞≈∏‚Äù¬ê Admin Access</div>
            <input type="password" id="adminPassword" placeholder="Enter admin password">
            <button class="btn btn-primary" onclick="adminLogin()" style="margin-top: 12px;">
                Login as Admin
            </button>
        </div>

        <!-- MAIN CONTENT (Only for approved users) -->
        <div id="mainContent" class="hidden">
            <!-- PENDING APPROVALS (Admin Only) -->
            <div id="pendingApprovalsSection" class="admin-section hidden">
                <div class="admin-title">√∞≈∏‚Äò¬• Pending Access Requests</div>
                <div id="pendingUsersList"></div>
            </div>

            <!-- CONFIGURE DEBTS (Admin Only) -->
            <div id="configSection" class="admin-section hidden">
                <div class="admin-title">√¢≈°‚Ñ¢√Ø¬∏¬è Configure Initial Debts</div>
                <div class="config-grid">
                    <div class="config-input-group">
                        <div class="config-input-label">Bhargav (A)</div>
                        <input type="number" id="configDebtA" placeholder="66250" min="0">
                    </div>
                    <div class="config-input-group">
                        <div class="config-input-label">Sagar (B)</div>
                        <input type="number" id="configDebtB" placeholder="66250" min="0">
                    </div>
                    <div class="config-input-group">
                        <div class="config-input-label">Bharat (C)</div>
                        <input type="number" id="configDebtC" placeholder="17450" min="0">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="updateDebts()">
                    √∞≈∏‚Äô¬æ Update Debts
                </button>
            </div>

            <!-- REMAINING TOTAL DEBT HIGHLIGHT -->
            <div class="debt-highlight" id="debtHighlight">
                <div class="label">√¢≈° √Ø¬∏¬è Total Remaining Debt for Person X</div>
                <div class="value" id="remainingTotalDebt">√¢‚Äö¬π149,950</div>
            </div>

            <div class="summary-card">
                <div class="summary-row">
                    <span class="summary-label">Total Debt Paid to X:</span>
                    <span class="summary-value" id="totalDebtPaid">√¢‚Äö¬π0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total Salary Paid:</span>
                    <span class="summary-value" id="totalSalaryPaid">√¢‚Äö¬π0</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total Extra Payments:</span>
                    <span class="summary-value" id="totalExtraPayments">√¢‚Äö¬π0</span>
                </div>
            </div>

            <!-- MONTHLY SALARY REPORT -->
            <div class="split-card">
                <div class="split-header">√∞≈∏‚Äú‚Ä¶ Monthly Salary Report</div>
                <div class="monthly-selector">
                    <select id="monthSelect">
                        <option value="">Select Month</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                    <input type="number" id="yearInput" placeholder="2026" min="2020" max="2030">
                </div>
                <button class="btn btn-secondary" onclick="loadMonthlyReport()">
                    √∞≈∏‚Äú≈† View Report
                </button>
                <div id="monthlyReportSection" class="hidden"></div>
            </div>

            <!-- Regular Payment Section -->
            <div id="paymentSection" class="hidden">
                <div class="input-card">
                    <div class="input-label">
                        √∞≈∏‚Äô¬∞ Enter Payment Amount (√¢‚Äö¬π)
                        <span class="fifty-badge" id="splitBadge">50/50 Split</span>
                    </div>
                    <input type="number" id="paymentInput" placeholder="20000" min="0" step="0.01">

                    <!-- DATE RANGE INPUTS -->
                    <div class="input-label" style="margin-top: 8px;">
                        √∞≈∏‚Äú‚Ä¶ Payment Period (Optional)
                    </div>
                    <div class="date-range-grid">
                        <div>
                            <div class="date-range-label">From Date</div>
                            <input type="date" id="paymentStartDate">
                        </div>
                        <div>
                            <div class="date-range-label">To Date</div>
                            <input type="date" id="paymentEndDate">
                        </div>
                    </div>

                    <div class="input-label" style="margin-top: 8px;">
                        √∞≈∏‚Äô¬¨ Comment/Remark (Optional)
                    </div>
                    <textarea id="paymentComment" placeholder="e.g., Project ABC payment, Monthly salary, etc."></textarea>
                </div>
                <button class="btn btn-primary" onclick="recordPayment()">
                    √∞≈∏‚Äú¬ù Record Payment
                </button>

                <!-- Extra Payment Section -->
                <div class="input-card" style="margin-top: 20px;">
                    <div class="input-label">
                        √∞≈∏‚Äô¬≥ Extra Payment (Reduces Partner's Debt)
                    </div>
                    <select id="extraPaymentPartner">
                        <option value="">Select Partner</option>
                        <option value="A">Bhargav</option>
                        <option value="B">Sagar</option>
                        <option value="C">Bharat</option>
                    </select>
                    <input type="number" id="extraPaymentAmount" placeholder="Amount (√¢‚Äö¬π)" min="0" step="0.01">

                    <div class="input-label" style="margin-top: 8px;">
                        √∞≈∏‚Äô¬¨ Comment/Remark (Optional)
                    </div>
                    <textarea id="extraPaymentComment" placeholder="e.g., Personal contribution, Advance payment, etc."></textarea>
                </div>
                <button class="btn btn-success" onclick="recordExtraPayment()">
                    √∞≈∏‚Äô¬µ Record Extra Payment
                </button>

                <!-- NEW DEBT SECTION -->
                <div class="input-card" style="margin-top: 20px; border: 2px solid #ff9800;">
                    <div class="input-label" style="color: #ff9800;">
                        √∞≈∏‚Ä†‚Ä¢ Add New Debt (Separate from Initial Debt)
                    </div>
                    <select id="newDebtPartner">
                        <option value="">Select Partner</option>
                        <option value="A">Bhargav</option>
                        <option value="B">Sagar</option>
                        <option value="C">Bharat</option>
                    </select>
                    <input type="number" id="newDebtAmount" placeholder="New Debt Amount (√¢‚Äö¬π)" min="0" step="0.01">

                    <div class="input-label" style="margin-top: 8px;">
                        √∞≈∏‚Äô¬¨ Comment/Remark (Optional)
                    </div>
                    <textarea id="newDebtComment" placeholder="e.g., Additional investment, New expense, etc."></textarea>
                </div>
                <button class="btn btn-warning" onclick="addNewDebt()">
                    √¢≈æ‚Ä¢ Add New Debt
                </button>
            </div>

            <!-- Payment Preview -->
            <div id="splitPreview" class="split-card hidden">
                <div class="split-header">√∞≈∏‚Äú≈† Payment Breakdown</div>
                <div class="split-row">
                    <span class="split-label">Total Payment:</span>
                    <span class="split-value" id="previewTotal">√¢‚Äö¬π0</span>
                </div>
                <div class="split-row">
                    <span class="split-label">To Person X:</span>
                    <span class="split-value" id="previewPersonX">√¢‚Äö¬π0</span>
                </div>
                <div class="split-row">
                    <span class="split-label">Total Salary:</span>
                    <span class="split-value" id="previewSalary">√¢‚Äö¬π0</span>
                </div>
                <div class="split-row">
                    <span class="split-label">Debt Clear Rate:</span>
                    <span class="split-value" id="previewClearRate">0%</span>
                </div>
            </div>

            <!-- Partner Preview -->
            <div id="partnerPreview" class="hidden">
                <div class="section-title">√∞≈∏‚Äò¬• Partner Distribution</div>

                <div class="partner-card">
                    <div class="partner-header">
                        √∞≈∏‚Äò¬§ <span class="partner-name">Bhargav (A) - 30%</span>
                    </div>
                    <div class="partner-row">
                        <span class="partner-label">Share Amount:</span>
                        <span class="partner-value">√¢‚Äö¬π<span id="previewShareA">0</span></span>
                    </div>
                    <div class="partner-row">
                        <span class="partner-label">Debt Payment:</span>
                        <span class="partner-value">√¢‚Äö¬π<span id="previewDebtA">0</span></span>
                    </div>
                    <div class="partner-row">
                        <span class="partner-label">Salary Received:</span>
                        <span class="partner-value">√¢‚Äö¬π<span id="previewSalaryA">0</span></span>
                    </div>
                </div>

                <div class="partner-card">
                    <div class="partner-header">
                        √∞≈∏‚Äò¬§ <span class="partner-name">Sagar (B) - 30%</span>
                    </div>
                    <div class="partner-row">
                        <span class="partner-label">Share Amount:</span>
                        <span class="partner-value">√¢‚Äö¬π<span id="previewShareB">0</span></span>
                    </div>
                    <div class="partner-row">
                        <span class="partner-label">Debt Payment:</span>
                        <span class="partner-value">√¢‚Äö¬π<span id="previewDebtB">0</span></span>
                    </div>
                    <div class="partner-row">
                        <span class="partner-label">Salary Received:</span>
                        <span class="partner-value">√¢‚Äö¬π<span id="previewSalaryB">0</span></span>
                    </div>
                </div>

                <div class="partner-card">
                    <div class="partner-header">
                        √∞≈∏‚Äò¬§ <span class="partner-name">Bharat (C) - 40%</span>
                    </div>
                    <div class="partner-row">
                        <span class="partner-label">Share Amount:</span>
                        <span class="partner-value">√¢‚Äö¬π<span id="previewShareC">0</span></span>
                    </div>
                    <div class="partner-row">
                        <span class="partner-label">Debt Payment:</span>
                        <span class="partner-value">√¢‚Äö¬π<span id="previewDebtC">0</span></span>
                    </div>
                    <div class="partner-row">
                        <span class="partner-label">Salary Received:</span>
                        <span class="partner-value">√¢‚Äö¬π<span id="previewSalaryC">0</span></span>
                    </div>
                </div>
            </div>

            <!-- Remaining Debts -->
            <div class="section-title">√∞≈∏‚Äô¬∞ Debt Status</div>
            <div class="partner-card">
                <div class="partner-header">√∞≈∏‚Äò¬§ <span class="partner-name">Bhargav (A)</span></div>
                <div class="partner-row">
                    <span class="partner-label">Initial Debt:</span>
                    <span class="partner-value" id="initialDebtA">√¢‚Äö¬π66,250</span>
                </div>
                <div class="partner-row">
                    <span class="partner-label">Paid (Regular):</span>
                    <span class="partner-value paid" id="paidDebtA">√¢‚Äö¬π0</span>
                </div>
                <div class="partner-row">
                    <span class="partner-label">Extra Paid:</span>
                    <span class="partner-value paid" id="extraA">√¢‚Äö¬π0</span>
                </div>
                <div class="partner-row">
                    <span class="partner-label">Remaining:</span>
                    <span class="partner-value" id="debtA">√¢‚Äö¬π66,250</span>
                </div>
            </div>

            <div class="partner-card">
                <div class="partner-header">√∞≈∏‚Äò¬§ <span class="partner-name">Sagar (B)</span></div>
                <div class="partner-row">
                    <span class="partner-label">Initial Debt:</span>
                    <span class="partner-value" id="initialDebtB">√¢‚Äö¬π66,250</span>
                </div>
                <div class="partner-row">
                    <span class="partner-label">Paid (Regular):</span>
                    <span class="partner-value paid" id="paidDebtB">√¢‚Äö¬π0</span>
                </div>
                <div class="partner-row">
                    <span class="partner-label">Extra Paid:</span>
                    <span class="partner-value paid" id="extraB">√¢‚Äö¬π0</span>
                </div>
                <div class="partner-row">
                    <span class="partner-label">Remaining:</span>
                    <span class="partner-value" id="debtB">√¢‚Äö¬π66,250</span>
                </div>
            </div>

            <div class="partner-card">
                <div class="partner-header">√∞≈∏‚Äò¬§ <span class="partner-name">Bharat (C)</span></div>
                <div class="partner-row">
                    <span class="partner-label">Initial Debt:</span>
                    <span class="partner-value" id="initialDebtC">√¢‚Äö¬π17,450</span>
                </div>
                <div class="partner-row">
                    <span class="partner-label">Paid (Regular):</span>
                    <span class="partner-value paid" id="paidDebtC">√¢‚Äö¬π0</span>
                </div>
                <div class="partner-row">
                    <span class="partner-label">Extra Paid:</span>
                    <span class="partner-value paid" id="extraC">√¢‚Äö¬π0</span>
                </div>
                <div class="partner-row">
                    <span class="partner-label">Remaining:</span>
                    <span class="partner-value" id="debtC">√¢‚Äö¬π17,450</span>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="toggleHistory()">
                √∞≈∏‚Äú≈ì <span id="historyBtnText">View Payment History</span>
            </button>

            <div id="historySection" class="hidden">
                <div class="history-card">
                    <div class="history-header">√∞≈∏‚Äú‚Ä¶ Payment History</div>
                    <div id="historyList"></div>
                </div>
            </div>

            <div id="adminControls" class="hidden admin-section">
                <div class="admin-title">√¢≈°‚Ñ¢√Ø¬∏¬è Admin Controls</div>
                <button class="btn btn-secondary" onclick="toggleConfigSection()">
                    √¢≈°‚Ñ¢√Ø¬∏¬è Configure Debts
                </button>
                <button class="btn btn-secondary" onc
        <!-- PARTNERSHIP CONFIGURATION MODAL -->
        <div id="partnershipModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">‚öôÔ∏è Configure Partners & Shares</div>
                <div class="modal-body">
                    <div id="partnersList">
                        <!-- Partners will be dynamically loaded here -->
                    </div>
                    <button class="btn btn-success" onclick="addNewPartnerRow()" style="margin-top: 12px;">
                        ‚ûï Add New Partner
                    </button>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary btn-small" onclick="closePartnershipModal()">Cancel</button>
                    <button class="btn btn-primary btn-small" onclick="savePartnershipConfig()">üíæ Save Changes</button>
                </div>
            </div>
        </div>

lick="togglePendingApprovals()">
                    √∞≈∏‚Äò¬• View Pending Approvals
                </button>
                
                    <button type="button" onclick="handleExportData()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px;">
                        <span style="font-size: 20px;">√∞≈∏‚Äú¬•</span> Export Data Backup
                    </button>

                    <button type="button" onclick="handleImportData()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px;">
                        <span style="font-size: 20px;">√∞≈∏‚Äú¬§</span> Import Data Backup
                    </button>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleFileSelected(event)">

                    <button type="button" onclick="handleOpenPartnershipConfig()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px;">
                        <span style="font-size: 20px;">√¢≈°‚Ñ¢√Ø¬∏¬è</span> Configure Partners & Shares
                    </button>

                    <button class="btn btn-secondary" onclick="resetData()">
                    √∞≈∏‚Äù‚Äû Reset All Data
                </button>
            </div>
        </div>

        <!-- EDIT MODAL -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">√¢≈ì¬è√Ø¬∏¬è Edit Payment</div>
                <div class="modal-body">
                    <div class="input-label">Amount (√¢‚Äö¬π)</div>
                    <input type="number" id="editAmount" min="0" step="0.01">

                    <div class="input-label">From Date (Optional)</div>
                    <input type="date" id="editStartDate">

                    <div class="input-label">To Date (Optional)</div>
                    <input type="date" id="editEndDate">

                    <div class="input-label">Comment</div>
                    <textarea id="editComment"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary btn-small" onclick="closeEditModal()">Cancel</button>
                    <button class="btn btn-primary btn-small" onclick="saveEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        let INITIAL_DEBTS = { A: 66250, B: 66250, C: 17450 };
        const SHAREHOLDING = { A: 0.30, B: 0.30, C: 0.40 };

        let isAdmin = false;
        let isApproved = false;
        let telegramId = tg.initDataUnsafe?.user?.id || null;
        let userName = tg.initDataUnsafe?.user?.first_name || 'User';
        let currentEditId = null;
        let debtFullyPaid = false;

        async function init() {
            await checkAccessStatus();
            setupEventListeners();
        }

        function setupEventListeners() {
            document.getElementById('paymentInput').addEventListener('input', calculatePreview);
        }

        async function checkAccessStatus() {
            try {
                const response = await fetch(`${API_URL}/api/admin/check?telegramId=${telegramId}`);
                const data = await response.json();

                isAdmin = data.isAdmin;
                isApproved = data.isApproved;

                if (isAdmin) {
                    showAdminUI();
                    await loadConfig();
                    await loadState();
                    await loadPendingApprovals();
                } else if (isApproved) {
                    showUserUI();
                    await loadConfig();
                    await loadState();
                } else if (!data.hasAdmin) {
                    document.getElementById('adminLoginSection').classList.remove('hidden');
                } else {
                    document.getElementById('accessRequestSection').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error checking access:', error);
            }
        }

        async function requestAccess() {
            try {
                const response = await fetch(`${API_URL}/api/access/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId, userName })
                });

                const data = await response.json();

                if (data.approved) {
                    showAlert('√¢≈ì‚Ä¶ Access granted!', 'success');
                    await checkAccessStatus();
                } else if (data.pending) {
                    document.getElementById('accessRequestSection').classList.add('hidden');
                    document.getElementById('pendingAccessSection').classList.remove('hidden');
                    showAlert('√∞≈∏‚Äú¬® Request sent to admin', 'info');
                }
            } catch (error) {
                showAlert('√¢¬ù≈í Network error', 'error');
            }
        }

        async function loadPendingApprovals() {
            if (!isAdmin) return;

            try {
                const response = await fetch(`${API_URL}/api/access/pending?telegramId=${telegramId}`);
                const data = await response.json();

                const list = document.getElementById('pendingUsersList');

                if (data.pending && data.pending.length > 0) {
                    list.innerHTML = data.pending.map(user => `
                        <div class="pending-user-item">
                            <div class="pending-user-info">
                                <div class="pending-user-name">${escapeHtml(user.userName)}</div>
                                <div class="pending-user-id">ID: ${user.telegramId}</div>
                            </div>
                            <div class="pending-actions">
                                <button class="btn btn-success btn-small" onclick="approveUser('${user.telegramId}')">
                                    √¢≈ì‚Ä¶ Approve
                                </button>
                                <button class="btn btn-danger btn-small" onclick="rejectUser('${user.telegramId}')">
                                    √¢¬ù≈í Reject
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div style="text-align:center;color:#666;padding:12px;">No pending requests</div>';
                }
            } catch (error) {
                console.error('Error loading approvals:', error);
            }
        }

        async function approveUser(userId) {
            try {
                const response = await fetch(`${API_URL}/api/access/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId, userId })
                });

                if (response.ok) {
                    showAlert('√¢≈ì‚Ä¶ User approved', 'success');
                    await loadPendingApprovals();
                }
            } catch (error) {
                showAlert('√¢¬ù≈í Error approving user', 'error');
            }
        }

        async function rejectUser(userId) {
            try {
                const response = await fetch(`${API_URL}/api/access/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId, userId })
                });

                if (response.ok) {
                    showAlert('√¢¬ù≈í User rejected', 'info');
                    await loadPendingApprovals();
                }
            } catch (error) {
                showAlert('√¢¬ù≈í Error rejecting user', 'error');
            }
        }

        function togglePendingApprovals() {
            const section = document.getElementById('pendingApprovalsSection');
            section.classList.toggle('hidden');
            if (!section.classList.contains('hidden')) {
                loadPendingApprovals();
            }
        }

        function showAdminUI() {
            document.getElementById('adminBadge').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('paymentSection').classList.remove('hidden');
            document.getElementById('adminControls').classList.remove('hidden');
            document.getElementById('adminLoginSection').classList.add('hidden');
            document.getElementById('accessRequestSection').classList.add('hidden');
            document.getElementById('pendingAccessSection').classList.add('hidden');
        }

        function showUserUI() {
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('adminLoginSection').classList.add('hidden');
            document.getElementById('accessRequestSection').classList.add('hidden');
            document.getElementById('pendingAccessSection').classList.add('hidden');
        }

        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (!password) {
                showAlert('Please enter password', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, telegramId })
                });

                if (response.ok) {
                    isAdmin = true;
                    isApproved = true;
                    showAlert('√¢≈ì‚Ä¶ Admin access granted!', 'success');
                    showAdminUI();
                    await loadConfig();
                    await loadState();
                } else {
                    showAlert('√¢¬ù≈í Invalid password', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        async function loadConfig() {
            try {
                const response = await fetch(`${API_URL}/api/config`);
                const config = await response.json();
                INITIAL_DEBTS = config.initialDebts;

                document.getElementById('configDebtA').value = INITIAL_DEBTS.A;
                document.getElementById('configDebtB').value = INITIAL_DEBTS.B;
                document.getElementById('configDebtC').value = INITIAL_DEBTS.C;

                document.getElementById('initialDebtA').textContent = `√¢‚Äö¬π${formatNumber(INITIAL_DEBTS.A)}`;
                document.getElementById('initialDebtB').textContent = `√¢‚Äö¬π${formatNumber(INITIAL_DEBTS.B)}`;
                document.getElementById('initialDebtC').textContent = `√¢‚Äö¬π${formatNumber(INITIAL_DEBTS.C)}`;
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        async function updateDebts() {
            if (!isAdmin) {
                showAlert('√¢‚Ä∫‚Äù Admin access required', 'error');
                return;
            }

            const debtA = parseFloat(document.getElementById('configDebtA').value);
            const debtB = parseFloat(document.getElementById('configDebtB').value);
            const debtC = parseFloat(document.getElementById('configDebtC').value);

            if (!debtA || !debtB || !debtC || debtA < 0 || debtB < 0 || debtC < 0) {
                showAlert('√¢≈° √Ø¬∏¬è Enter valid debt amounts', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/config/debts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ debtA, debtB, debtC, telegramId })
                });

                if (response.ok) {
                    showAlert('√¢≈ì‚Ä¶ Debts updated & recalculated!', 'success');
                    await loadConfig();
                    await loadState();
                    document.getElementById('configSection').classList.add('hidden');
                } else {
                    showAlert('√¢¬ù≈í Failed to update', 'error');
                }
            } catch (error) {
                showAlert('√¢¬ù≈í Network error', 'error');
            }
        }

        function toggleConfigSection() {
            const section = document.getElementById('configSection');
            section.classList.toggle('hidden');
        }

        function getTotalDebt() {
            return INITIAL_DEBTS.A + INITIAL_DEBTS.B + INITIAL_DEBTS.C;
        }

        async function loadState() {
            try {
                const response = await fetch(`${API_URL}/api/state?telegramId=${telegramId}`);
                const state = await response.json();

                document.getElementById('totalDebtPaid').textContent = `√¢‚Äö¬π${formatNumber(state.totalDebtPaid)}`;
                document.getElementById('totalSalaryPaid').textContent = `√¢‚Äö¬π${formatNumber(state.totalSalaryPaid)}`;
                document.getElementById('totalExtraPayments').textContent = `√¢‚Äö¬π${formatNumber(state.totalExtraPayments || 0)}`;

                debtFullyPaid = state.debtFullyPaid;

                const debtHighlight = document.getElementById('debtHighlight');
                const remainingDebt = state.remainingDebt || 0;

                document.getElementById('remainingTotalDebt').textContent = `√¢‚Äö¬π${formatNumber(remainingDebt)}`;

                if (debtFullyPaid || remainingDebt <= 0) {
                    debtHighlight.classList.add('complete');
                    debtHighlight.querySelector('.label').textContent = '√∞≈∏≈Ω‚Ä∞ All Debts Fully Paid!';
                    document.getElementById('splitBadge').textContent = '100% Salary';
                    document.getElementById('splitBadge').className = 'debt-complete-badge';
                } else {
                    debtHighlight.classList.remove('complete');
                    debtHighlight.querySelector('.label').textContent = '√¢≈° √Ø¬∏¬è Total Remaining Debt for Person X';
                    document.getElementById('splitBadge').textContent = '50/50 Split';
                    document.getElementById('splitBadge').className = 'fifty-badge';
                }

                updateRemainingDebts(state.debtPaid || { A: 0, B: 0, C: 0 }, state.extraPayments || { A: 0, B: 0, C: 0 });
                updateExtraPayments(state.extraPayments || { A: 0, B: 0, C: 0 });
            } catch (error) {
                console.error('Error loading state:', error);
            }
        }

        function updateRemainingDebts(debtPaid, extraPayments) {
            document.getElementById('paidDebtA').textContent = `√¢‚Äö¬π${formatNumber(debtPaid.A)}`;
            document.getElementById('paidDebtB').textContent = `√¢‚Äö¬π${formatNumber(debtPaid.B)}`;
            document.getElementById('paidDebtC').textContent = `√¢‚Äö¬π${formatNumber(debtPaid.C)}`;

            const debtA = Math.max(0, INITIAL_DEBTS.A - debtPaid.A - (extraPayments.A || 0));
            const debtB = Math.max(0, INITIAL_DEBTS.B - debtPaid.B - (extraPayments.B || 0));
            const debtC = Math.max(0, INITIAL_DEBTS.C - debtPaid.C - (extraPayments.C || 0));

            document.getElementById('debtA').textContent = `√¢‚Äö¬π${formatNumber(debtA)}`;
            document.getElementById('debtB').textContent = `√¢‚Äö¬π${formatNumber(debtB)}`;
            document.getElementById('debtC').textContent = `√¢‚Äö¬π${formatNumber(debtC)}`;
        }

        function updateExtraPayments(extraPayments) {
            document.getElementById('extraA').textContent = `√¢‚Äö¬π${formatNumber(extraPayments.A || 0)}`;
            document.getElementById('extraB').textContent = `√¢‚Äö¬π${formatNumber(extraPayments.B || 0)}`;
            document.getElementById('extraC').textContent = `√¢‚Äö¬π${formatNumber(extraPayments.C || 0)}`;
        }

        function calculatePreview() {
            const payment = parseFloat(document.getElementById('paymentInput').value) || 0;

            if (payment <= 0) {
                document.getElementById('splitPreview').classList.add('hidden');
                document.getElementById('partnerPreview').classList.add('hidden');
                return;
            }

            const shareA = payment * SHAREHOLDING.A;
            const shareB = payment * SHAREHOLDING.B;
            const shareC = payment * SHAREHOLDING.C;

            let toPersonX, toSalary;

            if (debtFullyPaid) {
                toPersonX = 0;
                toSalary = payment;
            } else {
                toPersonX = payment * 0.5;
                toSalary = payment * 0.5;
            }

            document.getElementById('previewTotal').textContent = `√¢‚Äö¬π${formatNumber(payment)}`;
            document.getElementById('previewPersonX').textContent = `√¢‚Äö¬π${formatNumber(toPersonX)}`;
            document.getElementById('previewSalary').textContent = `√¢‚Äö¬π${formatNumber(toSalary)}`;
            document.getElementById('previewClearRate').textContent = debtFullyPaid ? '0% (Debt Paid)' : '~50%';

            document.getElementById('previewShareA').textContent = formatNumber(shareA);
            document.getElementById('previewShareB').textContent = formatNumber(shareB);
            document.getElementById('previewShareC').textContent = formatNumber(shareC);

            document.getElementById('splitPreview').classList.remove('hidden');
            document.getElementById('partnerPreview').classList.remove('hidden');
        }

        async function recordPayment() {
            if (!isAdmin) {
                showAlert('√¢‚Ä∫‚Äù Admin access required', 'error');
                return;
            }

            const amount = parseFloat(document.getElementById('paymentInput').value);
            const comment = document.getElementById('paymentComment').value.trim();
            const paymentStartDate = document.getElementById('paymentStartDate').value;
            const paymentEndDate = document.getElementById('paymentEndDate').value;

            if (!amount || amount <= 0) {
                showAlert('√¢≈° √Ø¬∏¬è Enter valid amount', 'error');
                return;
            }

            // Validate dates if provided
            if ((paymentStartDate && !paymentEndDate) || (!paymentStartDate && paymentEndDate)) {
                showAlert('√¢≈° √Ø¬∏¬è Please provide both start and end dates or leave both empty', 'error');
                return;
            }

            if (paymentStartDate && paymentEndDate) {
                const startDate = new Date(paymentStartDate);
                const endDate = new Date(paymentEndDate);

                if (startDate > endDate) {
                    showAlert('√¢≈° √Ø¬∏¬è Start date must be before or equal to end date', 'error');
                    return;
                }
            }

            try {
                const response = await fetch(`${API_URL}/api/payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        amount, 
                        recordedBy: userName, 
                        telegramId, 
                        comment,
                        paymentStartDate: paymentStartDate || null,
                        paymentEndDate: paymentEndDate || null
                    })
                });

                if (response.ok) {
                    showAlert('√¢≈ì‚Ä¶ Payment recorded!', 'success');
                    document.getElementById('paymentInput').value = '';
                    document.getElementById('paymentComment').value = '';
                    document.getElementById('paymentStartDate').value = '';
                    document.getElementById('paymentEndDate').value = '';
                    document.getElementById('splitPreview').classList.add('hidden');
                    document.getElementById('partnerPreview').classList.add('hidden');
                    await loadState();
                } else {
                    showAlert('√¢¬ù≈í Failed to record', 'error');
                }
            } catch (error) {
                showAlert('√¢¬ù≈í Network error', 'error');
            }
        }

        async function recordExtraPayment() {
            if (!isAdmin) {
                showAlert('√¢‚Ä∫‚Äù Admin access required', 'error');
                return;
            }

            const partner = document.getElementById('extraPaymentPartner').value;
            const amount = parseFloat(document.getElementById('extraPaymentAmount').value);
            const comment = document.getElementById('extraPaymentComment').value.trim();

            if (!partner || !amount || amount <= 0) {
                showAlert('√¢≈° √Ø¬∏¬è Select partner and enter amount', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/extra-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partner, amount, recordedBy: userName, telegramId, comment })
                });

                if (response.ok) {
                    showAlert('√¢≈ì‚Ä¶ Extra payment recorded!', 'success');
                    document.getElementById('extraPaymentPartner').value = '';
                    document.getElementById('extraPaymentAmount').value = '';
                    document.getElementById('extraPaymentComment').value = '';
                    await loadState();
                } else {
                    showAlert('√¢¬ù≈í Failed to record', 'error');
                }
            } catch (error) {
                showAlert('√¢¬ù≈í Network error', 'error');
            }
        }

        async function addNewDebt() {
            if (!isAdmin) {
                showAlert('√¢‚Ä∫‚Äù Admin access required', 'error');
                return;
            }

            const partner = document.getElementById('newDebtPartner').value;
            const amount = parseFloat(document.getElementById('newDebtAmount').value);
            const comment = document.getElementById('newDebtComment').value.trim();

            if (!partner || !amount || amount <= 0) {
                showAlert('√¢≈° √Ø¬∏¬è Select partner and enter debt amount', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/extra-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        partner, 
                        amount: -amount,
                        recordedBy: userName, 
                        telegramId, 
                        comment: '√∞≈∏‚Ä†‚Ä¢ NEW DEBT: ' + (comment || 'Additional debt added')
                    })
                });

                if (response.ok) {
                    showAlert('√¢≈ì‚Ä¶ New debt added!', 'success');
                    document.getElementById('newDebtPartner').value = '';
                    document.getElementById('newDebtAmount').value = '';
                    document.getElementById('newDebtComment').value = '';
                    await loadState();
                } else {
                    showAlert('√¢¬ù≈í Failed to add debt', 'error');
                }
            } catch (error) {
                showAlert('√¢¬ù≈í Network error', 'error');
            }
        }

        function openEditModal(paymentId, amount, comment, startDate, endDate) {
            currentEditId = paymentId;
            document.getElementById('editAmount').value = amount;
            document.getElementById('editComment').value = comment || '';
            document.getElementById('editStartDate').value = startDate || '';
            document.getElementById('editEndDate').value = endDate || '';
            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEditId = null;
        }

        async function saveEdit() {
            if (!isAdmin || !currentEditId) return;

            const amount = parseFloat(document.getElementById('editAmount').value);
            const comment = document.getElementById('editComment').value.trim();
            const paymentStartDate = document.getElementById('editStartDate').value;
            const paymentEndDate = document.getElementById('editEndDate').value;

            if (!amount || amount <= 0) {
                showAlert('√¢≈° √Ø¬∏¬è Enter valid amount', 'error');
                return;
            }

            // Validate dates if provided
            if ((paymentStartDate && !paymentEndDate) || (!paymentStartDate && paymentEndDate)) {
                showAlert('√¢≈° √Ø¬∏¬è Please provide both start and end dates or leave both empty', 'error');
                return;
            }

            if (paymentStartDate && paymentEndDate) {
                const startDate = new Date(paymentStartDate);
                const endDate = new Date(paymentEndDate);

                if (startDate > endDate) {
                    showAlert('√¢≈° √Ø¬∏¬è Start date must be before or equal to end date', 'error');
                    return;
                }
            }

            try {
                const response = await fetch(`${API_URL}/api/payment/${currentEditId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        amount, 
                        comment, 
                        telegramId,
                        paymentStartDate: paymentStartDate || null,
                        paymentEndDate: paymentEndDate || null
                    })
                });

                if (response.ok) {
                    showAlert('√¢≈ì‚Ä¶ Payment updated!', 'success');
                    closeEditModal();
                    await loadState();
                    await loadHistory();
                } else {
                    showAlert('√¢¬ù≈í Failed to update', 'error');
                }
            } catch (error) {
                showAlert('√¢¬ù≈í Network error', 'error');
            }
        }

        async function deletePayment(paymentId) {
            if (!isAdmin) {
                showAlert('√¢‚Ä∫‚Äù Admin access required', 'error');
                return;
            }

            if (!confirm('√¢≈° √Ø¬∏¬è Delete this payment entry?')) return;

            try {
                const response = await fetch(`${API_URL}/api/payment/${paymentId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId })
                });

                if (response.ok) {
                    showAlert('√¢≈ì‚Ä¶ Payment deleted!', 'success');
                    await loadState();
                    await loadHistory();
                } else {
                    showAlert('√¢¬ù≈í Failed to delete', 'error');
                }
            } catch (error) {
                showAlert('√¢¬ù≈í Network error', 'error');
            }
        }

        let historyVisible = false;
        async function toggleHistory() {
            historyVisible = !historyVisible;
            const section = document.getElementById('historySection');
            const btnText = document.getElementById('historyBtnText');

            if (historyVisible) {
                await loadHistory();
                section.classList.remove('hidden');
                btnText.textContent = 'Hide Payment History';
            } else {
                section.classList.add('hidden');
                btnText.textContent = 'View Payment History';
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/api/history?telegramId=${telegramId}&limit=50`);
                const data = await response.json();

                const list = document.getElementById('historyList');
                if (data.history && data.history.length > 0) {
                    list.innerHTML = data.history.map(item => {
                        const editBtn = isAdmin ? `<button class="btn btn-warning btn-small" onclick="openEditModal('${item.id}', ${item.amount}, '${escapeHtml(item.comment || '')}', '${item.paymentStartDate || ''}', '${item.paymentEndDate || ''}')">√¢≈ì¬è√Ø¬∏¬è Edit</button>` : '';
                        const deleteBtn = isAdmin ? `<button class="btn btn-danger btn-small" onclick="deletePayment('${item.id}')">√∞≈∏‚Äî‚Äò√Ø¬∏¬è Delete</button>` : '';

                        const commentHtml = item.comment ? `
                            <div class="history-comment">
                                <span class="history-comment-icon">√∞≈∏‚Äô¬¨</span>${escapeHtml(item.comment)}
                            </div>
                        ` : '';

                        const dateRangeHtml = item.paymentStartDate && item.paymentEndDate ? `
                            <div class="history-date-range">
                                √∞≈∏‚Äú‚Ä¶ ${formatDateShort(item.paymentStartDate)} √¢‚Ä†‚Äô ${formatDateShort(item.paymentEndDate)}
                            </div>
                        ` : '';

                        const isNewDebt = item.comment && item.comment.includes('√∞≈∏‚Ä†‚Ä¢ NEW DEBT');
                        const itemClass = isNewDebt ? 'history-item new-debt' : (item.type === 'extra' ? 'history-item extra-payment' : 'history-item');

                        if (item.type === 'extra') {
                            const partnerNames = { A: 'Bhargav', B: 'Sagar', C: 'Bharat' };
                            const badge = isNewDebt ? '<span class="new-debt-badge">NEW DEBT</span>' : '';

                            return `
                                <div class="${itemClass}">
                                    <div class="history-item-header">
                                        <div class="history-amount">√∞≈∏‚Äô¬µ ${item.amount >= 0 ? 'Extra' : 'New Debt'}: √¢‚Äö¬π${formatNumber(Math.abs(item.amount))}${badge}</div>
                                        <div class="history-actions">
                                            ${editBtn}
                                            ${deleteBtn}
                                        </div>
                                    </div>
                                    <div class="history-split">
                                        ${item.amount >= 0 ? 'Paid' : 'Added'} by: ${partnerNames[item.partner]}
                                    </div>
                                    ${commentHtml}
                                    <div class="history-meta">
                                        ${new Date(item.timestamp).toLocaleString('en-IN', { 
                                            day: '2-digit', month: 'short', year: 'numeric', 
                                            hour: '2-digit', minute: '2-digit' 
                                        })}
                                        ${item.recordedBy ? ' √¢‚Ç¨¬¢ ' + item.recordedBy : ''}
                                        ${item.editedAt ? ' √¢‚Ç¨¬¢ <span style="color:#ff9800;">Edited</span>' : ''}
                                    </div>
                                </div>
                            `;
                        } else {
                            const details = item.partnerDetails;
                            return `
                                <div class="${itemClass}">
                                    <div class="history-item-header">
                                        <div class="history-amount">√¢‚Äö¬π${formatNumber(item.amount)}</div>
                                        <div class="history-actions">
                                            ${editBtn}
                                            ${deleteBtn}
                                        </div>
                                    </div>
                                    <div class="history-split">
                                        To Person X: √¢‚Äö¬π${formatNumber(item.toPersonX)} | 
                                        Salary: √¢‚Äö¬π${formatNumber(item.toSalary)}
                                    </div>
                                    ${dateRangeHtml}
                                    ${commentHtml}
                                    <div class="history-partner-details">
                                        <div class="history-partner-row">
                                            <span>√∞≈∏‚Äò¬§ Bhargav (30%):</span>
                                            <span>Share √¢‚Äö¬π${formatNumber(details.A.share)} √¢‚Ä†‚Äô Debt √¢‚Äö¬π${formatNumber(details.A.debt)} + Salary √¢‚Äö¬π${formatNumber(details.A.salary)}</span>
                                        </div>
                                        <div class="history-partner-row">
                                            <span>√∞≈∏‚Äò¬§ Sagar (30%):</span>
                                            <span>Share √¢‚Äö¬π${formatNumber(details.B.share)} √¢‚Ä†‚Äô Debt √¢‚Äö¬π${formatNumber(details.B.debt)} + Salary √¢‚Äö¬π${formatNumber(details.B.salary)}</span>
                                        </div>
                                        <div class="history-partner-row">
                                            <span>√∞≈∏‚Äò¬§ Bharat (40%):</span>
                                            <span>Share √¢‚Äö¬π${formatNumber(details.C.share)} √¢‚Ä†‚Äô Debt √¢‚Äö¬π${formatNumber(details.C.debt)} + Salary √¢‚Äö¬π${formatNumber(details.C.salary)}</span>
                                        </div>
                                    </div>
                                    <div class="history-meta">
                                        ${new Date(item.timestamp).toLocaleString('en-IN', { 
                                            day: '2-digit', month: 'short', year: 'numeric', 
                                            hour: '2-digit', minute: '2-digit' 
                                        })}
                                        ${item.recordedBy ? ' √¢‚Ç¨¬¢ ' + item.recordedBy : ''}
                                        ${item.editedAt ? ' √¢‚Ç¨¬¢ <span style="color:#ff9800;">Edited</span>' : ''}
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                } else {
                    list.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">No payments yet</div>';
                }
            } catch (error) {
                showAlert('Failed to load history', 'error');
            }
        }

        async function loadMonthlyReport() {
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearInput').value;

            if (!month || !year) {
                showAlert('√¢≈° √Ø¬∏¬è Select month and year', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/monthly?telegramId=${telegramId}&month=${month}&year=${year}`);
                const data = await response.json();

                const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];

                const reportSection = document.getElementById('monthlyReportSection');

                if (data.totalPayments === 0) {
                    reportSection.innerHTML = `
                        <div style="text-align:center;color:#666;padding:20px;margin-top:16px;">
                            No payments in ${monthNames[month]} ${year}
                        </div>
                    `;
                } else {
                    reportSection.innerHTML = `
                        <div class="monthly-summary">
                            <h3 style="margin-bottom:12px;color:#667eea;">${monthNames[month]} ${year} Summary</h3>
                            <div class="monthly-summary-row">
                                <span>Total Payments:</span>
                                <strong>${data.totalPayments}</strong>
                            </div>
                            <div class="monthly-summary-row">
                                <span>Total Amount:</span>
                                <strong>√¢‚Äö¬π${formatNumber(data.totalAmount)}</strong>
                            </div>
                            <div class="monthly-summary-row">
                                <span>Debt Paid to X:</span>
                                <strong>√¢‚Äö¬π${formatNumber(data.debtPaid)}</strong>
                            </div>
                            <div class="monthly-summary-row">
                                <span>Total Salary:</span>
                                <strong>√¢‚Äö¬π${formatNumber(data.totalSalary)}</strong>
                            </div>
                        </div>

                        <div style="margin-top:16px;">
                            <h4 style="margin-bottom:12px;color:#333;">Partner Salaries</h4>
                            <div class="partner-card" style="margin-bottom:8px;">
                                <div class="partner-row">
                                    <span>√∞≈∏‚Äò¬§ Bhargav (A):</span>
                                    <strong>√¢‚Äö¬π${formatNumber(data.salaries.A)}</strong>
                                </div>
                            </div>
                            <div class="partner-card" style="margin-bottom:8px;">
                                <div class="partner-row">
                                    <span>√∞≈∏‚Äò¬§ Sagar (B):</span>
                                    <strong>√¢‚Äö¬π${formatNumber(data.salaries.B)}</strong>
                                </div>
                            </div>
                            <div class="partner-card" style="margin-bottom:8px;">
                                <div class="partner-row">
                                    <span>√∞≈∏‚Äò¬§ Bharat (C):</span>
                                    <strong>√¢‚Äö¬π${formatNumber(data.salaries.C)}</strong>
                                </div>
                            </div>
                        </div>
                    `;
                }

                reportSection.classList.remove('hidden');
            } catch (error) {
                showAlert('√¢¬ù≈í Failed to load report', 'error');
            }
        }

        async function resetData() {
            if (!isAdmin) return;
            if (!confirm('√¢≈° √Ø¬∏¬è Delete ALL payment data?')) return;

            const password = prompt('Enter admin password:');
            if (!password) return;

            try {
                const response = await fetch(`${API_URL}/api/admin/reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, telegramId })
                });

                if (response.ok) {
                    showAlert('√¢≈ì‚Ä¶ Data reset', 'success');
                    await loadState();
                    document.getElementById('historySection').classList.add('hidden');
                    historyVisible = false;
                } else {
                    showAlert('√¢¬ù≈í Reset failed', 'error');
                }
            } catch (error) {
                showAlert('√¢¬ù≈í Network error', 'error');
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        function formatNumber(num) {
            return num.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        init();
    

// ========== AUTO SCROLL UTILITY ==========
function scrollToElement(elementId) {
    setTimeout(() => {
        const element = document.getElementById(elementId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 100);
}

// ========== NOTIFICATION SYSTEM ==========
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 25px;
        border-radius: 12px;
        color: white;
        font-weight: bold;
        font-size: 14px;
        z-index: 10002;
        animation: slideInTop 0.3s ease;
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        max-width: 90%;
        text-align: center;
        background: ${type === 'success' ? 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)' : 'linear-gradient(135deg, #ee0979 0%, #ff6a00 100%)'};
    `;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.style.animation = 'slideOutTop 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add notification animations
if (!document.querySelector('style[data-notification-animations]')) {
    const style = document.createElement('style');
    style.setAttribute('data-notification-animations', 'true');
    style.textContent = `
        @keyframes slideInTop {
            from { transform: translate(-50%, -100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideOutTop {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, -100px); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

// ========== DATA EXPORT FUNCTION ==========
async function handleExportData() {
    if (!isAdmin) {
        showNotification('√¢¬ù≈í Admin access required', 'error');
        return;
    }

    try {
        console.log('Export button clicked - preparing backup...');
        showNotification('√∞≈∏‚Äú¬¶ Creating backup...', 'info');

        // Fetch all data from server
        const [stateRes, historyRes, configRes] = await Promise.all([
            fetch(`${API_URL}/api/state?telegramId=${telegramId}`),
            fetch(`${API_URL}/api/history?telegramId=${telegramId}&limit=1000`),
            fetch(`${API_URL}/api/config`)
        ]);

        if (!stateRes.ok || !historyRes.ok || !configRes.ok) {
            throw new Error('Failed to fetch data from server');
        }

        const state = await stateRes.json();
        const history = await historyRes.json();
        const config = await configRes.json();

        const exportData = {
            version: "1.0",
            exportDate: new Date().toISOString(),
            exportedBy: userName,
            telegramId: telegramId,
            initialDebts: config.initialDebts || INITIAL_DEBTS,
            shareholding: SHAREHOLDING,
            state: state,
            history: history.history || [],
            timestamp: Date.now()
        };

        console.log('Backup data prepared:', exportData.history.length, 'records');

        // Send to server to create downloadable file
        const response = await fetch(`${API_URL}/api/create-backup`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                telegramId: telegramId,
                backupData: exportData
            })
        });

        if (response.ok) {
            const result = await response.json();

            if (result.downloadUrl) {
                // Open download URL in new window
                window.open(result.downloadUrl, '_blank');
                showNotification('√¢≈ì‚Ä¶ Opening download link...', 'success');
            } else {
                // Fallback: use blob download
                const filename = `partnership-backup-${new Date().toISOString().split('T')[0]}.json`;
                const dataStr = JSON.stringify(exportData, null, 2);

                // Try multiple download methods
                if (navigator.share && navigator.canShare) {
                    // Method 1: Web Share API (works on mobile)
                    const file = new File([dataStr], filename, {type: 'application/json'});

                    if (navigator.canShare({files: [file]})) {
                        await navigator.share({
                            files: [file],
                            title: 'Partnership Backup',
                            text: 'Backup data file'
                        });
                        showNotification('√¢≈ì‚Ä¶ Backup shared!', 'success');
                        return;
                    }
                }

                // Method 2: Direct download (desktop)
                const blob = new Blob([dataStr], {type: 'application/octet-stream'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();

                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);

                showNotification('√¢≈ì‚Ä¶ Backup downloaded! Check Downloads folder.', 'success');
            }

            console.log('Export completed successfully');
        } else {
            throw new Error('Server failed to create backup');
        }

    } catch (error) {
        console.error('Export error:', error);
        showNotification('√¢¬ù≈í Export failed: ' + error.message, 'error');
    }
}


// ========== DATA IMPORT FUNCTION ==========
function handleImportData() {
    console.log('Import button clicked');
    const fileInput = document.getElementById('importFileInput');
    if (fileInput) {
        fileInput.click();
    } else {
        console.error('File input not found');
        showNotification('√¢¬ù≈í Import button error', 'error');
    }
}

function handleFileSelected(event) {
        const file = event.target.files[0];
        if (!file) {
            console.log('No file selected');
            return;
        }

        console.log('File selected:', file.name);
        const reader = new FileReader();

        reader.onload = async function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                console.log('Parsed backup data:', importedData);

                // Support both formats:
                // 1. New format: state.partners (your current export)
                // 2. Old format: partners at root
                let partnersData, stateData;

                if (importedData.state && importedData.state.partners) {
                    // New format: partners inside state
                    partnersData = importedData.state.partners;
                    stateData = importedData.state;
                } else if (importedData.partners && importedData.state) {
                    // Old format: partners at root
                    partnersData = importedData.partners;
                    stateData = importedData.state;
                } else {
                    throw new Error('Invalid backup file format');
                }

                const dateStr = importedData.exportDate ? new Date(importedData.exportDate).toLocaleString() : 'unknown date';
                const payments = stateData.payments ? stateData.payments.length : 0;
                const partners = Object.keys(partnersData).length;

                const confirmMsg = `Import backup from ${dateStr}?\n\nPayments: ${payments}\nPartners: ${partners}\n\nThis will replace current data!`;

                if (confirm(confirmMsg)) {
                    console.log('User confirmed import');
                    showAlert('√∞≈∏‚Äú¬• Importing data...', 'info');

                    try {
                        const response = await fetch(`${API_URL}/api/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                telegramId: telegramId,
                                data: {
                                    partners: partnersData,
                                    state: stateData,
                                    approvedUsers: importedData.approvedUsers || []
                                }
                            })
                        });

                        const result = await response.json();
                        console.log('Import result:', result);

                        if (result.success) {
                            showAlert('√¢≈ì‚Ä¶ Import successful! Reloading...', 'success');
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            showAlert('√¢¬ù≈í Import failed: ' + (result.error || result.message), 'error');
                        }
                    } catch (error) {
                        console.error('Import API error:', error);
                        showAlert('√¢¬ù≈í Import failed: ' + error.message, 'error');
                    }
                } else {
                    console.log('User cancelled import');
                }
            } catch (error) {
                console.error('File parse error:', error);
                showAlert('√¢¬ù≈í Invalid backup file: ' + error.message, 'error');
            }
        };

        reader.onerror = function() {
            console.error('File read error');
            showAlert('√¢¬ù≈í Failed to read file', 'error');
        };

        reader.readAsText(file);
        event.target.value = '';;
    event.target.value = ''; // Reset file input
}

// ========== PARTNERSHIP CONFIGURATION ==========
let tempPartnerships = {};

function handleOpenPartnershipConfig() {
    console.log('Opening partnership config');
    try {
        tempPartnerships = JSON.parse(JSON.stringify(partnerships));
        renderPartnershipConfigList();
        const modal = document.getElementById('partnershipConfigModal');
        if (modal) {
            modal.style.display = 'block';
            scrollToElement('partnershipConfigModal');
            showNotification('√∞≈∏‚Äú¬ù Edit partners and shares below', 'success');
        } else {
            console.error('Partnership modal not found');
            showNotification('√¢¬ù≈í Modal not found', 'error');
        }
    } catch (error) {
        console.error('Error opening partnership config:', error);
        showNotification('√¢¬ù≈í Failed to open: ' + error.message, 'error');
    }
}

function handleClosePartnershipConfig() {
    console.log('Closing partnership config');
    const modal = document.getElementById('partnershipConfigModal');
    if (modal) {
        modal.style.display = 'none';
    }
    document.getElementById('newPartnerNameInput').value = '';
    document.getElementById('newPartnerShareInput').value = '';
}

function renderPartnershipConfigList() {
    const container = document.getElementById('partnersListConfigContainer');
    if (!container) {
        console.error('Partners list container not found');
        return;
    }

    const partnerNames = Object.keys(tempPartnerships);

    if (partnerNames.length === 0) {
        container.innerHTML = '<p style="color: white; text-align: center; padding: 20px; margin: 0;">No partners configured yet.<br>Add your first partner below.</p>';
        return;
    }

    let htmlContent = '';
    partnerNames.forEach((name, index) => {
        const share = tempPartnerships[name];
        const escapedName = name.replace(/'/g, "\\'");
        htmlContent += `
            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="partnerName_${index}" value="${name}" style="flex: 2; padding: 10px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; box-sizing: border-box;">
                    <input type="number" id="partnerShare_${index}" value="${share}" step="0.01" min="0" max="100" style="flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    <span style="color: white; font-weight: bold; font-size: 14px;">%</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="button" onclick="handleUpdatePartner('${escapedName}', ${index})" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; flex: 1; font-size: 13px;">
                        √¢≈ì‚Ä¶ Update
                    </button>
                    <button type="button" onclick="handleDeletePartner('${escapedName}')" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px;">
                        √∞≈∏‚Äî‚Äò√Ø¬∏¬è Delete
                    </button>
                </div>
            </div>
        `;
    });

    // Add total percentage indicator
    const totalPercentage = Object.values(tempPartnerships).reduce((sum, val) => sum + parseFloat(val), 0);
    const isValid = Math.abs(totalPercentage - 100) < 0.01;
    htmlContent += `
        <div style="background: ${isValid ? 'rgba(56,239,125,0.3)' : 'rgba(255,107,107,0.3)'}; padding: 15px; border-radius: 10px; text-align: center; margin-top: 10px;">
            <span style="color: white; font-weight: bold; font-size: 18px;">
                Total: ${totalPercentage.toFixed(2)}% ${isValid ? '√¢≈ì‚Ä¶' : '√¢≈° √Ø¬∏¬è Should be 100%'}
            </span>
        </div>
    `;

    container.innerHTML = htmlContent;
}

function handleAddNewPartner() {
    console.log('Adding new partner');
    const nameInput = document.getElementById('newPartnerNameInput');
    const shareInput = document.getElementById('newPartnerShareInput');

    const name = nameInput.value.trim();
    const share = parseFloat(shareInput.value);

    if (!name) {
        showNotification('√¢¬ù≈í Please enter partner name', 'error');
        return;
    }

    if (isNaN(share) || share <= 0 || share > 100) {
        showNotification('√¢¬ù≈í Please enter valid share (0-100)', 'error');
        return;
    }

    if (tempPartnerships[name]) {
        showNotification('√¢¬ù≈í Partner already exists', 'error');
        return;
    }

    tempPartnerships[name] = share;
    nameInput.value = '';
    shareInput.value = '';
    renderPartnershipConfigList();
    showNotification('√¢≈ì‚Ä¶ Partner added: ' + name, 'success');
    console.log('Partner added:', name, share);
}

function handleUpdatePartner(oldName, index) {
    console.log('Updating partner:', oldName);
    const newName = document.getElementById('partnerName_' + index).value.trim();
    const newShare = parseFloat(document.getElementById('partnerShare_' + index).value);

    if (!newName) {
        showNotification('√¢¬ù≈í Partner name cannot be empty', 'error');
        renderPartnershipConfigList();
        return;
    }

    if (isNaN(newShare) || newShare <= 0 || newShare > 100) {
        showNotification('√¢¬ù≈í Invalid share percentage', 'error');
        renderPartnershipConfigList();
        return;
    }

    // Check if name changed and new name already exists
    if (newName !== oldName && tempPartnerships[newName]) {
        showNotification('√¢¬ù≈í Partner name already exists', 'error');
        renderPartnershipConfigList();
        return;
    }

    // Delete old entry if name changed
    if (newName !== oldName) {
        delete tempPartnerships[oldName];
    }

    // Add/update with new values
    tempPartnerships[newName] = newShare;
    renderPartnershipConfigList();
    showNotification('√¢≈ì‚Ä¶ Partner updated', 'success');
    console.log('Partner updated:', newName, newShare);
}

function handleDeletePartner(name) {
    console.log('Deleting partner:', name);
    if (confirm(`Delete partner "${name}"?`)) {
        delete tempPartnerships[name];
        renderPartnershipConfigList();
        showNotification('√¢≈ì‚Ä¶ Partner deleted', 'success');
        console.log('Partner deleted:', name);
    }
}

function handleSavePartnershipConfig() {
    console.log('Saving partnership configuration');
    const totalPercentage = Object.values(tempPartnerships).reduce((sum, val) => sum + parseFloat(val), 0);

    if (Math.abs(totalPercentage - 100) > 0.01) {
        const confirmMsg = `Total percentage is ${totalPercentage.toFixed(2)}%, not 100%.\n\nContinue anyway?`;
        if (!confirm(confirmMsg)) {
            return;
        }
    }

    // Send to server
    fetch('/api/update-partnerships', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ partnerships: tempPartnerships })
    })
    .then(response => response.json())
    .then(result => {
        console.log('Save result:', result);
        if (result.success) {
            partnerships = JSON.parse(JSON.stringify(tempPartnerships));
            updatePartnerSelect();
            handleClosePartnershipConfig();
            showNotification('√¢≈ì‚Ä¶ Partnership configuration saved!', 'success');

            // Recalculate all entries with new shares
            entries.forEach(entry => {
                const partnerName = entry.partner || entry.type;
                if (partnerships[partnerName]) {
                    entry.share = partnerships[partnerName];
                    entry.partnerAmount = (entry.actualAmount * entry.share) / 100;
                }
            });
            updateEntriesTable();
            console.log('Partnerships updated successfully');
        } else {
            showNotification('√¢¬ù≈í Save failed: ' + result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Save API error:', error);
        showNotification('√¢¬ù≈í Failed to save: ' + error.message, 'error');
    });
}

console.log('√¢≈ì‚Ä¶ All backup and partnership functions loaded');


        // ==================== PARTNERSHIP CONFIGURATION ====================

        let partnersConfig = [];

        function handleOpenPartnershipConfig() {
            loadPartnersConfig();
            document.getElementById('partnershipModal').classList.add('show');
        }

        function closePartnershipModal() {
            document.getElementById('partnershipModal').classList.remove('show');
        }

        async function loadPartnersConfig() {
            try {
                // Load current shareholding configuration
                const response = await fetch(`${API_URL}/api/config`);
                const data = await response.json();

                // Convert SHAREHOLDING object to array format
                partnersConfig = [];
                for (let key in SHAREHOLDING) {
                    partnersConfig.push({
                        id: key,
                        name: getPartnerName(key),
                        share: SHAREHOLDING[key] * 100
                    });
                }

                renderPartnersList();
            } catch (error) {
                console.error('Error loading partners config:', error);
                showAlert('‚ùå Failed to load partners configuration', 'error');
            }
        }

        function getPartnerName(id) {
            const names = {
                'A': 'Bhargav',
                'B': 'Sagar',
                'C': 'Bharat'
            };
            return names[id] || 'Unknown';
        }

        function renderPartnersList() {
            const container = document.getElementById('partnersList');

            if (partnersConfig.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No partners configured. Click "Add New Partner" to start.</p>';
                return;
            }

            let html = '<div class="partner-config-header">Current Partners</div>';

            partnersConfig.forEach((partner, index) => {
                html += `
                    <div class="partner-config-item">
                        <div class="partner-config-row">
                            <div>
                                <div class="partner-config-label">ID</div>
                                <input type="text" class="partner-config-input" value="${partner.id}" 
                                       onchange="updatePartnerField(${index}, 'id', this.value)" 
                                       maxlength="10" placeholder="A, B, C...">
                            </div>
                            <div>
                                <div class="partner-config-label">Name</div>
                                <input type="text" class="partner-config-input" value="${partner.name}" 
                                       onchange="updatePartnerField(${index}, 'name', this.value)"
                                       placeholder="Partner Name">
                            </div>
                            <div>
                                <div class="partner-config-label">Share %</div>
                                <input type="number" class="partner-config-input" value="${partner.share}" 
                                       onchange="updatePartnerField(${index}, 'share', this.value)"
                                       min="0" max="100" step="0.01" placeholder="30">
                            </div>
                            <div style="padding-top: 20px;">
                                <button class="btn-remove-partner" onclick="removePartner(${index})">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Calculate total share percentage
            const totalShare = partnersConfig.reduce((sum, p) => sum + parseFloat(p.share || 0), 0);
            let shareClass = '';
            let shareMessage = '';

            if (totalShare === 100) {
                shareClass = '';
                shareMessage = `‚úÖ Total Share: ${totalShare.toFixed(2)}% (Perfect!)`;
            } else if (totalShare < 100) {
                shareClass = 'warning';
                shareMessage = `‚ö†Ô∏è Total Share: ${totalShare.toFixed(2)}% (${(100 - totalShare).toFixed(2)}% remaining)`;
            } else {
                shareClass = 'error';
                shareMessage = `‚ùå Total Share: ${totalShare.toFixed(2)}% (Exceeds 100% by ${(totalShare - 100).toFixed(2)}%)`;
            }

            html += `<div class="share-total-info ${shareClass}">${shareMessage}</div>`;

            container.innerHTML = html;
        }

        function updatePartnerField(index, field, value) {
            if (field === 'share') {
                partnersConfig[index][field] = parseFloat(value) || 0;
            } else {
                partnersConfig[index][field] = value;
            }
            renderPartnersList();
        }

        function addNewPartnerRow() {
            // Find next available ID letter
            const existingIds = partnersConfig.map(p => p.id);
            let newId = 'A';
            for (let i = 65; i <= 90; i++) { // A-Z
                const letter = String.fromCharCode(i);
                if (!existingIds.includes(letter)) {
                    newId = letter;
                    break;
                }
            }

            partnersConfig.push({
                id: newId,
                name: '',
                share: 0
            });

            renderPartnersList();
            showAlert('‚ûï New partner row added. Please fill in the details.', 'info');
        }

        function removePartner(index) {
            const partner = partnersConfig[index];
            if (confirm(`Are you sure you want to remove ${partner.name || partner.id}?`)) {
                partnersConfig.splice(index, 1);
                renderPartnersList();
                showAlert('üóëÔ∏è Partner removed', 'success');
            }
        }

        async function savePartnershipConfig() {
            // Validate total share
            const totalShare = partnersConfig.reduce((sum, p) => sum + parseFloat(p.share || 0), 0);

            if (Math.abs(totalShare - 100) > 0.01) {
                showAlert(`‚ùå Total share must equal 100%. Currently: ${totalShare.toFixed(2)}%`, 'error');
                return;
            }

            // Validate all fields are filled
            for (let partner of partnersConfig) {
                if (!partner.id || !partner.name || partner.share <= 0) {
                    showAlert('‚ùå Please fill in all partner details (ID, Name, and Share)', 'error');
                    return;
                }
            }

            // Check for duplicate IDs
            const ids = partnersConfig.map(p => p.id);
            if (new Set(ids).size !== ids.length) {
                showAlert('‚ùå Partner IDs must be unique', 'error');
                return;
            }

            try {
                // Convert to the format expected by the backend
                const newShareholding = {};
                const newDebts = {};

                partnersConfig.forEach(partner => {
                    newShareholding[partner.id] = partner.share / 100;
                    // Preserve existing debt or set to 0 for new partners
                    newDebts[partner.id] = INITIAL_DEBTS[partner.id] || 0;
                });

                // Update shareholding configuration
                const response = await fetch(`${API_URL}/api/config/shareholding`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        shareholding: newShareholding,
                        debts: newDebts
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update local variables
                    Object.keys(SHAREHOLDING).forEach(key => delete SHAREHOLDING[key]);
                    Object.assign(SHAREHOLDING, newShareholding);

                    Object.keys(INITIAL_DEBTS).forEach(key => delete INITIAL_DEBTS[key]);
                    Object.assign(INITIAL_DEBTS, newDebts);

                    showAlert('‚úÖ Partnership configuration updated successfully!', 'success');
                    closePartnershipModal();
                    await loadState();
                } else {
                    showAlert('‚ùå Failed to save configuration', 'error');
                }
            } catch (error) {
                console.error('Error saving partnership config:', error);
                showAlert('‚ùå Error saving configuration', 'error');
            }
        }

</script>

    <!-- Partnership Configuration Modal -->
    <div id="partnershipConfigModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; overflow-y: auto; padding: 15px; box-sizing: border-box;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 10px auto; padding: 20px; border-radius: 20px; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <h2 style="color: white; text-align: center; margin: 0 0 20px 0; font-size: 20px;">√∞≈∏‚Äò¬• Partnership Configuration</h2>

            <div id="partnersListConfigContainer" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                <!-- Partners will be listed here -->
            </div>

            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                <h3 style="color: white; margin: 0 0 12px 0; font-size: 16px;">√¢≈æ‚Ä¢ Add New Partner</h3>
                <input type="text" id="newPartnerNameInput" placeholder="Partner Name" style="width: 100%; padding: 12px; border: none; border-radius: 10px; margin-bottom: 8px; font-size: 15px; box-sizing: border-box;">
                <input type="number" id="newPartnerShareInput" placeholder="Share Percentage" step="0.01" min="0" max="100" style="width: 100%; padding: 12px; border: none; border-radius: 10px; margin-bottom: 8px; font-size: 15px; box-sizing: border-box;">
                <button type="button" onclick="handleAddNewPartner()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 15px;">
                    √¢≈ì‚Ä¶ Add Partner
                </button>
            </div>

            <div style="display: flex; gap: 8px;">
                <button type="button" onclick="handleSavePartnershipConfig()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: bold; flex: 1; font-size: 15px;">
                    √∞≈∏‚Äô¬æ Save
                </button>
                <button type="button" onclick="handleClosePartnershipConfig()" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; border: none; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: bold; flex: 1; font-size: 15px;">
                    √¢¬ù≈í Cancel
                </button>
            </div>
        </div>
    </div>
</body>
</html>