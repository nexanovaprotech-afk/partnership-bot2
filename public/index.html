<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partnership Calculator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #333);
            padding: 16px;
            padding-bottom: 80px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color, white);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 24px; margin-bottom: 8px; }
        .section {
            background: var(--tg-theme-secondary-bg-color, white);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-secondary {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, white);
        }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .hidden { display: none !important; }
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, white);
            color: var(--tg-theme-text-color, #333);
        }
        .partner-config-item {
            padding: 12px;
            background: var(--tg-theme-bg-color, #f5f5f5);
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .partner-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .partner-id {
            font-weight: 700;
            font-size: 18px;
            color: #667eea;
        }
        .btn-remove {
            padding: 6px 12px;
            font-size: 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .stat-card {
            padding: 12px;
            background: var(--tg-theme-bg-color, #f5f5f5);
            border-radius: 8px;
        }
        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--tg-theme-text-color, #333);
        }
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        .history-item {
            padding: 12px;
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #f5f5f5);
            margin-bottom: 8px;
        }
        .admin-section {
            border: 2px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Access Screen -->
        <div id="accessScreen" class="hidden">
            <div class="section">
                <h2 style="text-align:center">üîê Access Required</h2>
                <p id="accessMessage" style="text-align:center;margin:16px 0">Requesting access...</p>
                <button class="btn btn-primary" onclick="requestAccess()">Request Access</button>
            </div>
        </div>

        <!-- Admin Login -->
        <div id="adminLoginScreen" class="hidden">
            <div class="section">
                <h2 style="text-align:center">üîë Admin Setup</h2>
                <p style="text-align:center;margin:16px 0">Set up admin access</p>
                <div class="form-group">
                    <input type="password" id="adminPassword" class="form-input" placeholder="Enter admin password">
                </div>
                <button class="btn btn-primary" onclick="adminLogin()">Set as Admin</button>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <div class="header">
                <h1>üíº Partnership Calculator</h1>
                <p id="userInfo"></p>
            </div>

            <div id="alertContainer"></div>

            <!-- Admin Controls -->
            <div id="adminControls" class="hidden section admin-section">
                <div class="section-title">‚öôÔ∏è Admin Controls</div>
                <button class="btn btn-secondary" onclick="togglePartnerConfig()">üë• Manage Partners</button>
                <button class="btn btn-primary" onclick="togglePaymentForm()">üí∞ Record Payment</button>
                <button class="btn btn-warning" onclick="toggleExtraPaymentForm()">üíµ Extra Payment</button>
                <button class="btn btn-danger" onclick="toggleNewDebtForm()">üÜï Add New Debt</button>
                <button class="btn btn-success" onclick="exportData()">üì§ Export Backup</button>
                <button class="btn btn-warning" onclick="importData()">üì• Import Backup</button>
            </div>

            <!-- Partner Configuration -->
            <div id="partnerConfigSection" class="hidden section admin-section">
                <div class="section-title">üë• Manage Partners</div>
                <div id="partnerConfigList"></div>
                <button class="btn btn-success" onclick="showAddPartnerForm()">‚ûï Add New Partner</button>
                <button class="btn btn-primary" onclick="savePartnerConfig()">üíæ Save Changes</button>
                <button class="btn btn-secondary" onclick="togglePartnerConfig()">‚ùå Cancel</button>
            </div>

            <!-- Add Partner Form -->
            <div id="addPartnerForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">Partner ID (e.g., D, E)</label>
                    <input type="text" id="newPartnerId" class="form-input" maxlength="5" placeholder="D">
                </div>
                <div class="form-group">
                    <label class="form-label">Partner Name</label>
                    <input type="text" id="newPartnerName" class="form-input" placeholder="Enter name">
                </div>
                <div class="form-group">
                    <label class="form-label">Initial Debt (‚Çπ)</label>
                    <input type="number" id="newPartnerDebt" class="form-input" placeholder="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Share (%) - Will be auto-adjusted</label>
                    <input type="number" id="newPartnerShare" class="form-input" step="0.01" placeholder="0">
                </div>
                <button class="btn btn-success" onclick="addPartner()">‚úÖ Add Partner</button>
                <button class="btn btn-secondary" onclick="cancelAddPartner()">‚ùå Cancel</button>
            </div>

            <!-- State Display -->
            <div class="section">
                <div class="section-title">üìä Current State</div>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">Remaining Debt</div>
                        <div class="stat-value" id="remainingDebt">‚Çπ0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Debt Paid</div>
                        <div class="stat-value" id="totalDebtPaid">‚Çπ0</div>
                    </div>
                </div>
            </div>

            <!-- Partners Display -->
            <div class="section">
                <div class="section-title">üë• Partners</div>
                <div id="partnersDisplay"></div>
            </div>

            <!-- Payment Form -->
            <div id="paymentForm" class="hidden section admin-section">
                <div class="section-title">üí∞ Record Payment</div>
                <div class="form-group">
                    <label class="form-label">Amount (‚Çπ)</label>
                    <input type="number" id="paymentAmount" class="form-input" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label class="form-label">Comment (Optional)</label>
                    <textarea id="paymentComment" class="form-input" placeholder="Add a note..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitPayment()">‚úÖ Submit Payment</button>
                <button class="btn btn-secondary" onclick="togglePaymentForm()">‚ùå Cancel</button>
            </div>

            <!-- Extra Payment Form -->
            <div id="extraPaymentForm" class="hidden section admin-section">
                <div class="section-title">üíµ Extra Payment</div>
                <div class="form-group">
                    <label class="form-label">Partner</label>
                    <select id="extraPartner" class="form-input"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (‚Çπ)</label>
                    <input type="number" id="extraAmount" class="form-input" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label class="form-label">Comment (Optional)</label>
                    <textarea id="extraComment" class="form-input" placeholder="Add a note..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitExtraPayment()">‚úÖ Submit</button>
                <button class="btn btn-secondary" onclick="toggleExtraPaymentForm()">‚ùå Cancel</button>
            </div>

            <!-- New Debt Form -->
            <div id="newDebtForm" class="hidden section admin-section">
                <div class="section-title">üÜï Add New Debt</div>
                <div class="form-group">
                    <label class="form-label">Partner</label>
                    <select id="debtPartner" class="form-input"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Debt Amount (‚Çπ)</label>
                    <input type="number" id="debtAmount" class="form-input" placeholder="Enter debt amount">
                </div>
                <div class="form-group">
                    <label class="form-label">Comment (Optional)</label>
                    <textarea id="debtComment" class="form-input" placeholder="Reason for debt..."></textarea>
                </div>
                <button class="btn btn-danger" onclick="submitNewDebt()">‚úÖ Add Debt</button>
                <button class="btn btn-secondary" onclick="toggleNewDebtForm()">‚ùå Cancel</button>
            </div>

            <!-- History -->
            <div class="section">
                <div class="section-title">üìú Payment History</div>
                <div id="historyContainer">Loading...</div>
            </div>
        </div>
    </div>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const API_URL = window.location.origin;
        let telegramId = null;
        let userName = 'User';
        let isAdmin = false;
        let partners = {};

        async function init() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                telegramId = tg.initDataUnsafe.user.id;
                userName = tg.initDataUnsafe.user.first_name || 'User';
            } else {
                telegramId = 'demo_' + Date.now();
                userName = 'Demo User';
            }

            document.getElementById('userInfo').textContent = `Welcome, ${userName}!`;
            await checkAdminStatus();
        }

        async function checkAdminStatus() {
            try {
                const response = await fetch(`${API_URL}/api/admin/check?telegramId=${telegramId}`);
                const data = await response.json();

                if (!data.hasAdmin) {
                    document.getElementById('adminLoginScreen').classList.remove('hidden');
                } else if (data.isAdmin) {
                    isAdmin = true;
                    showMainApp();
                } else if (data.isApproved) {
                    showMainApp();
                } else {
                    showAccessScreen();
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (!password) {
                showAlert('Please enter password', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, telegramId })
                });

                if (response.ok) {
                    isAdmin = true;
                    showMainApp();
                    showAlert('Admin access granted!', 'success');
                } else {
                    showAlert('Invalid password', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function showAccessScreen() {
            document.getElementById('accessScreen').classList.remove('hidden');
            document.getElementById('adminLoginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        async function requestAccess() {
            try {
                const response = await fetch(`${API_URL}/api/access/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId, userName })
                });

                const data = await response.json();
                if (data.approved) {
                    showMainApp();
                } else {
                    document.getElementById('accessMessage').textContent = 'Request sent! Waiting for approval...';
                    showAlert('Request sent to admin', 'info');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function showMainApp() {
            document.getElementById('accessScreen').classList.add('hidden');
            document.getElementById('adminLoginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            if (isAdmin) {
                document.getElementById('adminControls').classList.remove('hidden');
            }

            loadState();
            loadHistory();
        }

        async function loadState() {
            try {
                const response = await fetch(`${API_URL}/api/state?telegramId=${telegramId}`);
                const data = await response.json();

                partners = data.partners;

                document.getElementById('remainingDebt').textContent = '‚Çπ' + data.remainingDebt.toLocaleString('en-IN');
                document.getElementById('totalDebtPaid').textContent = '‚Çπ' + data.totalDebtPaid.toLocaleString('en-IN');

                updatePartnersDisplay();
                updatePartnerSelects();
            } catch (error) {
                showAlert('Failed to load state', 'error');
            }
        }

        function updatePartnersDisplay() {
            const container = document.getElementById('partnersDisplay');
            container.innerHTML = Object.keys(partners).map(key => {
                const partner = partners[key];
                return `
                    <div class="stat-card" style="margin-bottom:8px">
                        <div style="font-weight:600;font-size:16px;margin-bottom:4px">${partner.name} (${key})</div>
                        <div style="font-size:12px;color:#999">Share: ${(partner.share * 100).toFixed(1)}% | Debt: ‚Çπ${partner.debt.toLocaleString('en-IN')}</div>
                    </div>
                `;
            }).join('');
        }

        function updatePartnerSelects() {
            const selects = [document.getElementById('extraPartner'), document.getElementById('debtPartner')];
            selects.forEach(select => {
                select.innerHTML = Object.keys(partners).map(key => 
                    `<option value="${key}">${partners[key].name} (${key})</option>`
                ).join('');
            });
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/api/history?telegramId=${telegramId}&limit=50`);
                const data = await response.json();

                const container = document.getElementById('historyContainer');

                if (data.history.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#999;">No payments yet</p>';
                    return;
                }

                container.innerHTML = data.history.map(payment => {
                    const date = new Date(payment.timestamp).toLocaleString('en-IN');
                    const isExtra = payment.type === 'extra';

                    let html = `<div class="history-item">
                        <div style="display:flex;justify-content:space-between">
                            <span style="font-weight:700;font-size:18px">‚Çπ${Math.abs(payment.amount).toLocaleString('en-IN')}</span>
                            <span style="font-size:12px;color:#999">${date}</span>
                        </div>`;

                    if (isExtra) {
                        const partnerName = partners[payment.partner]?.name || payment.partner;
                        html += `<div style="font-size:13px;margin-top:4px">${partnerName} - ${payment.amount < 0 ? 'New Debt' : 'Extra Payment'}</div>`;
                    } else {
                        html += `<div style="font-size:13px;margin-top:4px">To Person X: ‚Çπ${payment.toPersonX.toLocaleString('en-IN')}</div>`;
                    }

                    if (payment.comment) {
                        html += `<div style="font-size:12px;font-style:italic;color:#999;margin-top:4px">üí¨ ${payment.comment}</div>`;
                    }

                    html += `</div>`;
                    return html;
                }).join('');
            } catch (error) {
                document.getElementById('historyContainer').innerHTML = '<p style="text-align:center;color:red;">Failed to load history</p>';
            }
        }

        function togglePartnerConfig() {
            const section = document.getElementById('partnerConfigSection');
            section.classList.toggle('hidden');

            if (!section.classList.contains('hidden')) {
                renderPartnerConfig();
            }
        }

        function renderPartnerConfig() {
            const list = document.getElementById('partnerConfigList');
            list.innerHTML = Object.keys(partners).map(key => {
                const partner = partners[key];
                return `
                    <div class="partner-config-item">
                        <div class="partner-config-header">
                            <span class="partner-id">${key}</span>
                            <button class="btn-remove" onclick="removePartner('${key}')">Remove</button>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-input" id="partner_name_${key}" value="${partner.name}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Initial Debt (‚Çπ)</label>
                            <input type="number" class="form-input" id="partner_debt_${key}" value="${partner.debt}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Share (%)</label>
                            <input type="number" class="form-input" id="partner_share_${key}" step="0.01" value="${(partner.share * 100).toFixed(2)}">
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddPartnerForm() {
            document.getElementById('addPartnerForm').classList.remove('hidden');
        }

        function cancelAddPartner() {
            document.getElementById('addPartnerForm').classList.add('hidden');
            document.getElementById('newPartnerId').value = '';
            document.getElementById('newPartnerName').value = '';
            document.getElementById('newPartnerDebt').value = '';
            document.getElementById('newPartnerShare').value = '';
        }

        function addPartner() {
            const id = document.getElementById('newPartnerId').value.trim().toUpperCase();
            const name = document.getElementById('newPartnerName').value.trim();
            const debt = parseFloat(document.getElementById('newPartnerDebt').value) || 0;
            const share = parseFloat(document.getElementById('newPartnerShare').value) / 100 || 0;

            if (!id || !name) {
                showAlert('Please enter partner ID and name', 'error');
                return;
            }

            if (partners[id]) {
                showAlert('Partner ID already exists', 'error');
                return;
            }

            partners[id] = { name, debt, share };
            renderPartnerConfig();
            cancelAddPartner();
            showAlert('Partner added! Remember to save changes', 'info');
        }

        function removePartner(key) {
            if (!confirm(`Remove partner ${partners[key].name}?`)) return;
            delete partners[key];
            renderPartnerConfig();
            showAlert('Partner removed! Remember to save changes', 'info');
        }

        async function savePartnerConfig() {
            const updatedPartners = {};
            let totalShare = 0;

            for (const key of Object.keys(partners)) {
                const name = document.getElementById(`partner_name_${key}`)?.value;
                const debt = parseFloat(document.getElementById(`partner_debt_${key}`)?.value) || 0;
                const share = parseFloat(document.getElementById(`partner_share_${key}`)?.value) / 100 || 0;

                updatedPartners[key] = { name, debt, share };
                totalShare += share;
            }

            if (Math.abs(totalShare - 1.0) > 0.01) {
                showAlert(`Total share must be 100%! Current: ${(totalShare * 100).toFixed(1)}%`, 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/config/partners`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partners: updatedPartners, telegramId })
                });

                if (response.ok) {
                    showAlert('Partners configuration saved!', 'success');
                    await loadState();
                    togglePartnerConfig();
                } else {
                    const error = await response.json();
                    showAlert('Failed: ' + error.error, 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function togglePaymentForm() {
            document.getElementById('paymentForm').classList.toggle('hidden');
        }

        async function submitPayment() {
            const amount = document.getElementById('paymentAmount').value;
            const comment = document.getElementById('paymentComment').value;

            if (!amount || amount <= 0) {
                showAlert('Please enter valid amount', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseFloat(amount), recordedBy: userName, telegramId, comment })
                });

                if (response.ok) {
                    showAlert('Payment recorded!', 'success');
                    togglePaymentForm();
                    document.getElementById('paymentAmount').value = '';
                    document.getElementById('paymentComment').value = '';
                    await loadState();
                    await loadHistory();
                } else {
                    showAlert('Failed to record payment', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function toggleExtraPaymentForm() {
            document.getElementById('extraPaymentForm').classList.toggle('hidden');
        }

        async function submitExtraPayment() {
            const partner = document.getElementById('extraPartner').value;
            const amount = document.getElementById('extraAmount').value;
            const comment = document.getElementById('extraComment').value;

            if (!amount) {
                showAlert('Please enter amount', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/extra-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partner, amount: parseFloat(amount), recordedBy: userName, telegramId, comment })
                });

                if (response.ok) {
                    showAlert('Extra payment recorded!', 'success');
                    toggleExtraPaymentForm();
                    document.getElementById('extraAmount').value = '';
                    document.getElementById('extraComment').value = '';
                    await loadState();
                    await loadHistory();
                } else {
                    showAlert('Failed', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function toggleNewDebtForm() {
            document.getElementById('newDebtForm').classList.toggle('hidden');
        }

        async function submitNewDebt() {
            const partner = document.getElementById('debtPartner').value;
            const amount = document.getElementById('debtAmount').value;
            const comment = document.getElementById('debtComment').value;

            if (!amount || amount <= 0) {
                showAlert('Please enter valid debt amount', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/extra-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partner, amount: -parseFloat(amount), recordedBy: userName, telegramId, comment })
                });

                if (response.ok) {
                    showAlert('New debt added!', 'success');
                    toggleNewDebtForm();
                    document.getElementById('debtAmount').value = '';
                    document.getElementById('debtComment').value = '';
                    await loadState();
                    await loadHistory();
                } else {
                    showAlert('Failed', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        async function exportData() {
            if (!isAdmin) {
                showAlert('‚õî Admin access required', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/export?telegramId=${telegramId}`);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `partnership-backup-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showAlert('‚úÖ Data exported successfully!', 'success');
                } else {
                    showAlert('‚ùå Export failed', 'error');
                }
            } catch (error) {
                showAlert('‚ùå Network error', 'error');
            }
        }

        async function importData() {
            if (!isAdmin) {
                showAlert('‚õî Admin access required', 'error');
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    const confirmed = confirm(
                        '‚ö†Ô∏è IMPORT WARNING:\n\n' +
                        'This will replace ALL current data with backup data.\n\n' +
                        'Continue?'
                    );

                    if (!confirmed) return;

                    const response = await fetch(`${API_URL}/api/import`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ telegramId, data })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showAlert(`‚úÖ Imported: ${result.imported.partners} partners, ${result.imported.payments} payments`, 'success');
                        await loadState();
                        await loadHistory();
                    } else {
                        const error = await response.json();
                        showAlert('‚ùå Import failed: ' + error.error, 'error');
                    }
                } catch (error) {
                    showAlert('‚ùå Invalid backup file', 'error');
                }
            };

            input.click();
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            container.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        init();
    </script>
</body>
</html>