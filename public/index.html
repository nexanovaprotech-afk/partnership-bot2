<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partnership Calculator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #333);
            padding: 16px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color, white);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .section {
            background: var(--tg-theme-secondary-bg-color, white);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            padding: 12px;
            background: var(--tg-theme-bg-color, #f5f5f5);
            border-radius: 8px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--tg-theme-text-color, #333);
        }

        .debt-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .debt-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .debt-value {
            font-size: 32px;
            font-weight: 700;
        }

        .partner-grid {
            display: grid;
            gap: 12px;
        }

        .partner-card {
            padding: 12px;
            background: var(--tg-theme-bg-color, #f5f5f5);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .partner-name {
            font-weight: 600;
            font-size: 16px;
        }

        .partner-amount {
            font-weight: 700;
            font-size: 18px;
            color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, white);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, white);
            color: var(--tg-theme-text-color, #333);
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, white);
            color: var(--tg-theme-text-color, #333);
        }

        textarea.form-input {
            min-height: 80px;
            resize: vertical;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .history-item {
            padding: 12px;
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #f5f5f5);
            margin-bottom: 8px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-amount {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .history-date {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
        }

        .history-details {
            font-size: 13px;
            color: var(--tg-theme-text-color, #666);
            margin-bottom: 4px;
        }

        .history-comment {
            font-size: 12px;
            font-style: italic;
            color: var(--tg-theme-hint-color, #999);
            margin-top: 8px;
            padding: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
        }

        .history-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            flex: 1;
        }

        .loader {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999);
        }

        .access-section {
            text-align: center;
            padding: 40px 20px;
        }

        .access-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .pending-item {
            padding: 12px;
            background: var(--tg-theme-bg-color, #f5f5f5);
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pending-info {
            flex: 1;
        }

        .pending-actions {
            display: flex;
            gap: 8px;
        }

        .admin-section {
            border: 2px solid #667eea;
        }

        .admin-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #667eea;
        }

        .debt-complete {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .monthly-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .monthly-controls select {
            flex: 1;
        }

        .date-range-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .history-date-range {
            font-size: 11px;
            color: #667eea;
            margin-top: 4px;
        }

        .extra-payment-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #f59e0b;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .new-debt-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #ef4444;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Access Control Screen -->
        <div id="accessScreen" class="hidden">
            <div class="section access-section">
                <div class="access-icon">üîê</div>
                <h2>Access Required</h2>
                <p id="accessMessage" style="margin: 16px 0;">Requesting access...</p>
                <button class="btn btn-primary" onclick="requestAccess()">Request Access</button>
            </div>
        </div>

        <!-- Admin Login Screen -->
        <div id="adminLoginScreen" class="hidden">
            <div class="section access-section">
                <div class="access-icon">üîë</div>
                <h2>Admin Setup</h2>
                <p style="margin: 16px 0;">Set up admin access with password</p>
                <div class="form-group">
                    <input type="password" id="adminPassword" class="form-input" placeholder="Enter admin password">
                </div>
                <button class="btn btn-primary" onclick="adminLogin()">Set as Admin</button>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <!-- Header -->
            <div class="header">
                <h1>üíº Partnership Calculator</h1>
                <p id="userInfo"></p>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Current State -->
            <div class="section">
                <div class="section-title">üìä Current State</div>

                <div id="debtCard" class="debt-card">
                    <div class="debt-label">Remaining Debt</div>
                    <div class="debt-value" id="remainingDebt">‚Çπ0</div>
                </div>

                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Debt Paid</div>
                        <div class="stat-value" id="totalDebtPaid">‚Çπ0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Salary Paid</div>
                        <div class="stat-value" id="totalSalaryPaid">‚Çπ0</div>
                    </div>
                </div>
            </div>

            <!-- Individual Debt Paid -->
            <div class="section">
                <div class="section-title">üë• Individual Debt Cleared</div>
                <div class="partner-grid">
                    <div class="partner-card">
                        <span class="partner-name">Partner A</span>
                        <span class="partner-amount" id="debtPaidA">‚Çπ0</span>
                    </div>
                    <div class="partner-card">
                        <span class="partner-name">Partner B</span>
                        <span class="partner-amount" id="debtPaidB">‚Çπ0</span>
                    </div>
                    <div class="partner-card">
                        <span class="partner-name">Partner C</span>
                        <span class="partner-amount" id="debtPaidC">‚Çπ0</span>
                    </div>
                </div>
            </div>

            <!-- Extra Payments -->
            <div class="section">
                <div class="section-title">üíµ Extra Payments / New Debts</div>
                <div class="partner-grid">
                    <div class="partner-card">
                        <span class="partner-name">Partner A</span>
                        <span class="partner-amount" id="extraPaymentA">‚Çπ0</span>
                    </div>
                    <div class="partner-card">
                        <span class="partner-name">Partner B</span>
                        <span class="partner-amount" id="extraPaymentB">‚Çπ0</span>
                    </div>
                    <div class="partner-card">
                        <span class="partner-name">Partner C</span>
                        <span class="partner-amount" id="extraPaymentC">‚Çπ0</span>
                    </div>
                </div>
            </div>

            <!-- Admin Controls -->
            <div id="adminControls" class="hidden section admin-section">
                <div class="admin-title">‚öôÔ∏è Admin Controls</div>
                <button class="btn btn-secondary" onclick="toggleConfigSection()">‚öôÔ∏è Configure Debts</button>
                <button class="btn btn-primary" onclick="togglePaymentForm()">üí∞ Record Payment</button>
                <button class="btn btn-warning" onclick="toggleExtraPaymentForm()">üíµ Extra Payment</button>
                <button class="btn btn-danger" onclick="toggleNewDebtForm()">üÜï Add New Debt</button>
                <button class="btn btn-secondary" onclick="toggleMonthlyReport()">üìÖ Monthly Report</button>
                <button class="btn btn-secondary" onclick="togglePendingApprovals()">üë• Pending Approvals</button>
                <button class="btn btn-success" onclick="exportData()">üì§ Export Data (Backup)</button>
                <button class="btn btn-warning" onclick="importData()">üì• Import Data (Restore)</button>
            </div>

            <!-- Configure Debts Section -->
            <div id="configSection" class="hidden section admin-section">
                <div class="admin-title">‚öôÔ∏è Configure Initial Debts</div>
                <div class="form-group">
                    <label class="form-label">Partner A Debt (‚Çπ)</label>
                    <input type="number" id="debtA" class="form-input" placeholder="66250">
                </div>
                <div class="form-group">
                    <label class="form-label">Partner B Debt (‚Çπ)</label>
                    <input type="number" id="debtB" class="form-input" placeholder="66250">
                </div>
                <div class="form-group">
                    <label class="form-label">Partner C Debt (‚Çπ)</label>
                    <input type="number" id="debtC" class="form-input" placeholder="17450">
                </div>
                <button class="btn btn-primary" onclick="updateDebts()">üíæ Save Configuration</button>
                <button class="btn btn-secondary" onclick="toggleConfigSection()">‚ùå Cancel</button>
            </div>

            <!-- Payment Form -->
            <div id="paymentForm" class="hidden section admin-section">
                <div class="admin-title">üí∞ Record New Payment</div>
                <div class="form-group">
                    <label class="form-label">Amount (‚Çπ)</label>
                    <input type="number" id="paymentAmount" class="form-input" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label class="form-label">Comment (Optional)</label>
                    <textarea id="paymentComment" class="form-input" placeholder="Add a note..."></textarea>
                </div>
                <div class="date-range-group">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" id="paymentStartDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" id="paymentEndDate" class="form-input">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="submitPayment()">‚úÖ Submit Payment</button>
                <button class="btn btn-secondary" onclick="togglePaymentForm()">‚ùå Cancel</button>
            </div>

            <!-- Extra Payment Form -->
            <div id="extraPaymentForm" class="hidden section admin-section">
                <div class="admin-title">üíµ Record Extra Payment</div>
                <div class="form-group">
                    <label class="form-label">Partner</label>
                    <select id="extraPartner" class="form-select">
                        <option value="A">Partner A</option>
                        <option value="B">Partner B</option>
                        <option value="C">Partner C</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (‚Çπ)</label>
                    <input type="number" id="extraAmount" class="form-input" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label class="form-label">Comment (Optional)</label>
                    <textarea id="extraComment" class="form-input" placeholder="Add a note..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitExtraPayment()">‚úÖ Submit</button>
                <button class="btn btn-secondary" onclick="toggleExtraPaymentForm()">‚ùå Cancel</button>
            </div>

            <!-- New Debt Form -->
            <div id="newDebtForm" class="hidden section admin-section">
                <div class="admin-title">üÜï Add New Debt</div>
                <div class="form-group">
                    <label class="form-label">Partner</label>
                    <select id="debtPartner" class="form-select">
                        <option value="A">Partner A</option>
                        <option value="B">Partner B</option>
                        <option value="C">Partner C</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Debt Amount (‚Çπ)</label>
                    <input type="number" id="debtAmount" class="form-input" placeholder="Enter debt amount">
                </div>
                <div class="form-group">
                    <label class="form-label">Comment (Optional)</label>
                    <textarea id="debtComment" class="form-input" placeholder="Reason for debt..."></textarea>
                </div>
                <button class="btn btn-danger" onclick="submitNewDebt()">‚úÖ Add Debt</button>
                <button class="btn btn-secondary" onclick="toggleNewDebtForm()">‚ùå Cancel</button>
            </div>

            <!-- Monthly Report Section -->
            <div id="monthlyReportSection" class="hidden section">
                <div class="section-title">üìÖ Monthly Salary Report</div>
                <div class="monthly-controls">
                    <select id="reportMonth" class="form-select">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                    <select id="reportYear" class="form-select"></select>
                    <button class="btn btn-primary" onclick="loadMonthlyReport()">üîç View</button>
                </div>
                <div id="monthlyReportContent"></div>
                <button class="btn btn-secondary" onclick="toggleMonthlyReport()">‚ùå Close</button>
            </div>

            <!-- Pending Approvals Section -->
            <div id="pendingApprovalsSection" class="hidden section admin-section">
                <div class="admin-title">üë• Pending Access Requests</div>
                <div id="pendingApprovalsList"></div>
                <button class="btn btn-secondary" onclick="togglePendingApprovals()">‚ùå Close</button>
            </div>

            <!-- Payment History -->
            <div class="section">
                <div class="section-title">üìú Payment History</div>
                <div id="historyContainer">
                    <div class="loader">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        const API_URL = window.location.origin;
        let telegramId = null;
        let userName = 'User';
        let isAdmin = false;
        let currentEditId = null;

        // Initialize app
        async function init() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                telegramId = tg.initDataUnsafe.user.id;
                userName = tg.initDataUnsafe.user.first_name || tg.initDataUnsafe.user.username || 'User';
            } else {
                telegramId = 'demo_' + Date.now();
                userName = 'Demo User';
            }

            document.getElementById('userInfo').textContent = `Welcome, ${userName}!`;

            // Check admin status
            await checkAdminStatus();
        }

        async function checkAdminStatus() {
            try {
                const response = await fetch(`${API_URL}/api/admin/check?telegramId=${telegramId}`);
                const data = await response.json();

                if (!data.hasAdmin) {
                    // No admin set yet, show admin setup
                    document.getElementById('adminLoginScreen').classList.remove('hidden');
                } else if (data.isAdmin) {
                    // User is admin
                    isAdmin = true;
                    showMainApp();
                } else if (data.isApproved) {
                    // User is approved
                    showMainApp();
                } else {
                    // User needs approval
                    showAccessScreen();
                }
            } catch (error) {
                showAlert('Network error. Please check your connection.', 'error');
            }
        }

        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;

            if (!password) {
                showAlert('Please enter password', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, telegramId })
                });

                if (response.ok) {
                    isAdmin = true;
                    showMainApp();
                    showAlert('Admin access granted!', 'success');
                } else {
                    showAlert('Invalid password', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function showAccessScreen() {
            document.getElementById('accessScreen').classList.remove('hidden');
            document.getElementById('adminLoginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        async function requestAccess() {
            try {
                const response = await fetch(`${API_URL}/api/access/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId, userName })
                });

                const data = await response.json();

                if (data.approved) {
                    showMainApp();
                } else {
                    document.getElementById('accessMessage').textContent = 'Access request sent! Waiting for admin approval...';
                    showAlert('Request sent to admin', 'info');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function showMainApp() {
            document.getElementById('accessScreen').classList.add('hidden');
            document.getElementById('adminLoginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            if (isAdmin) {
                document.getElementById('adminControls').classList.remove('hidden');
            }

            loadState();
            loadHistory();
            initMonthlyReport();
        }

        async function loadState() {
            try {
                const response = await fetch(`${API_URL}/api/state?telegramId=${telegramId}`);
                const data = await response.json();

                document.getElementById('remainingDebt').textContent = '‚Çπ' + data.remainingDebt.toLocaleString('en-IN');
                document.getElementById('totalDebtPaid').textContent = '‚Çπ' + data.totalDebtPaid.toLocaleString('en-IN');
                document.getElementById('totalSalaryPaid').textContent = '‚Çπ' + data.totalSalaryPaid.toLocaleString('en-IN');

                document.getElementById('debtPaidA').textContent = '‚Çπ' + data.debtPaid.A.toLocaleString('en-IN');
                document.getElementById('debtPaidB').textContent = '‚Çπ' + data.debtPaid.B.toLocaleString('en-IN');
                document.getElementById('debtPaidC').textContent = '‚Çπ' + data.debtPaid.C.toLocaleString('en-IN');

                document.getElementById('extraPaymentA').textContent = '‚Çπ' + data.extraPayments.A.toLocaleString('en-IN');
                document.getElementById('extraPaymentB').textContent = '‚Çπ' + data.extraPayments.B.toLocaleString('en-IN');
                document.getElementById('extraPaymentC').textContent = '‚Çπ' + data.extraPayments.C.toLocaleString('en-IN');

                if (data.debtFullyPaid) {
                    document.getElementById('debtCard').classList.add('debt-complete');
                }
            } catch (error) {
                showAlert('Failed to load state', 'error');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/api/history?telegramId=${telegramId}&limit=50`);
                const data = await response.json();

                const container = document.getElementById('historyContainer');

                if (data.history.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#999;">No payments yet</p>';
                    return;
                }

                container.innerHTML = data.history.map(payment => {
                    const date = new Date(payment.timestamp).toLocaleString('en-IN');
                    const isExtra = payment.type === 'extra';
                    const isNewDebt = isExtra && payment.amount < 0;

                    let content = `
                        <div class="history-item">
                            <div class="history-header">
                                <span class="history-amount">‚Çπ${Math.abs(payment.amount).toLocaleString('en-IN')}</span>
                                <span class="history-date">${date}</span>
                            </div>
                    `;

                    if (isExtra) {
                        if (isNewDebt) {
                            content += `
                                <div class="history-details">
                                    Partner ${payment.partner}
                                    <span class="new-debt-badge">NEW DEBT</span>
                                </div>
                            `;
                        } else {
                            content += `
                                <div class="history-details">
                                    Partner ${payment.partner}
                                    <span class="extra-payment-badge">EXTRA PAYMENT</span>
                                </div>
                            `;
                        }
                    } else {
                        content += `
                            <div class="history-details">
                                To Person X: ‚Çπ${payment.toPersonX.toLocaleString('en-IN')} | 
                                To Salary: ‚Çπ${payment.toSalary.toLocaleString('en-IN')}
                            </div>
                        `;

                        if (payment.paymentStartDate && payment.paymentEndDate) {
                            const startDate = new Date(payment.paymentStartDate).toLocaleDateString('en-IN');
                            const endDate = new Date(payment.paymentEndDate).toLocaleDateString('en-IN');
                            content += `<div class="history-date-range">üìÖ ${startDate} - ${endDate}</div>`;
                        }
                    }

                    if (payment.comment) {
                        content += `<div class="history-comment">üí¨ ${payment.comment}</div>`;
                    }

                    if (isAdmin) {
                        content += `
                            <div class="history-actions">
                                <button class="btn btn-secondary btn-small" onclick="editPayment('${payment.id}')">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger btn-small" onclick="deletePayment('${payment.id}')">üóëÔ∏è Delete</button>
                            </div>
                        `;
                    }

                    content += `</div>`;
                    return content;
                }).join('');
            } catch (error) {
                document.getElementById('historyContainer').innerHTML = '<p style="text-align:center;color:red;">Failed to load history</p>';
            }
        }

        function toggleConfigSection() {
            const section = document.getElementById('configSection');
            section.classList.toggle('hidden');
        }

        async function updateDebts() {
            const debtA = document.getElementById('debtA').value;
            const debtB = document.getElementById('debtB').value;
            const debtC = document.getElementById('debtC').value;

            if (!debtA || !debtB || !debtC) {
                showAlert('Please fill all debt amounts', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/config/debts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ debtA, debtB, debtC, telegramId })
                });

                if (response.ok) {
                    showAlert('Debts updated successfully!', 'success');
                    toggleConfigSection();
                    await loadState();
                    await loadHistory();
                } else {
                    showAlert('Failed to update debts', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function togglePaymentForm() {
            const form = document.getElementById('paymentForm');
            form.classList.toggle('hidden');

            if (!form.classList.contains('hidden')) {
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentComment').value = '';
                document.getElementById('paymentStartDate').value = '';
                document.getElementById('paymentEndDate').value = '';
                currentEditId = null;
            }
        }

        async function submitPayment() {
            const amount = document.getElementById('paymentAmount').value;
            const comment = document.getElementById('paymentComment').value;
            const startDate = document.getElementById('paymentStartDate').value;
            const endDate = document.getElementById('paymentEndDate').value;

            if (!amount || amount <= 0) {
                showAlert('Please enter valid amount', 'error');
                return;
            }

            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                showAlert('Start date must be before end date', 'error');
                return;
            }

            try {
                const url = currentEditId ? `${API_URL}/api/payment/${currentEditId}` : `${API_URL}/api/payment`;
                const method = currentEditId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        amount: parseFloat(amount), 
                        recordedBy: userName,
                        telegramId,
                        comment,
                        paymentStartDate: startDate || null,
                        paymentEndDate: endDate || null
                    })
                });

                if (response.ok) {
                    showAlert(currentEditId ? 'Payment updated!' : 'Payment recorded!', 'success');
                    togglePaymentForm();
                    await loadState();
                    await loadHistory();
                } else {
                    showAlert('Failed to record payment', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function toggleExtraPaymentForm() {
            const form = document.getElementById('extraPaymentForm');
            form.classList.toggle('hidden');

            if (!form.classList.contains('hidden')) {
                document.getElementById('extraAmount').value = '';
                document.getElementById('extraComment').value = '';
            }
        }

        async function submitExtraPayment() {
            const partner = document.getElementById('extraPartner').value;
            const amount = document.getElementById('extraAmount').value;
            const comment = document.getElementById('extraComment').value;

            if (!amount) {
                showAlert('Please enter amount', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/extra-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        partner, 
                        amount: parseFloat(amount),
                        recordedBy: userName,
                        telegramId,
                        comment
                    })
                });

                if (response.ok) {
                    showAlert('Extra payment recorded!', 'success');
                    toggleExtraPaymentForm();
                    await loadState();
                    await loadHistory();
                } else {
                    showAlert('Failed to record extra payment', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function toggleNewDebtForm() {
            const form = document.getElementById('newDebtForm');
            form.classList.toggle('hidden');

            if (!form.classList.contains('hidden')) {
                document.getElementById('debtAmount').value = '';
                document.getElementById('debtComment').value = '';
            }
        }

        async function submitNewDebt() {
            const partner = document.getElementById('debtPartner').value;
            const amount = document.getElementById('debtAmount').value;
            const comment = document.getElementById('debtComment').value;

            if (!amount || amount <= 0) {
                showAlert('Please enter valid debt amount', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/extra-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        partner, 
                        amount: -parseFloat(amount),
                        recordedBy: userName,
                        telegramId,
                        comment
                    })
                });

                if (response.ok) {
                    showAlert('New debt added!', 'success');
                    toggleNewDebtForm();
                    await loadState();
                    await loadHistory();
                } else {
                    showAlert('Failed to add debt', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        async function editPayment(id) {
            const response = await fetch(`${API_URL}/api/history?telegramId=${telegramId}`);
            const data = await response.json();
            const payment = data.history.find(p => p.id === id);

            if (!payment) return;

            currentEditId = id;
            document.getElementById('paymentAmount').value = payment.amount;
            document.getElementById('paymentComment').value = payment.comment || '';

            if (payment.paymentStartDate) {
                document.getElementById('paymentStartDate').value = payment.paymentStartDate;
            }
            if (payment.paymentEndDate) {
                document.getElementById('paymentEndDate').value = payment.paymentEndDate;
            }

            togglePaymentForm();
        }

        async function deletePayment(id) {
            if (!confirm('Are you sure you want to delete this payment?')) return;

            try {
                const response = await fetch(`${API_URL}/api/payment/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId })
                });

                if (response.ok) {
                    showAlert('Payment deleted!', 'success');
                    await loadState();
                    await loadHistory();
                } else {
                    showAlert('Failed to delete payment', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        function initMonthlyReport() {
            const yearSelect = document.getElementById('reportYear');
            const currentYear = new Date().getFullYear();

            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('reportMonth').value = currentMonth;
        }

        function toggleMonthlyReport() {
            const section = document.getElementById('monthlyReportSection');
            section.classList.toggle('hidden');
        }

        async function loadMonthlyReport() {
            const month = document.getElementById('reportMonth').value;
            const year = document.getElementById('reportYear').value;

            try {
                const response = await fetch(`${API_URL}/api/monthly?telegramId=${telegramId}&month=${month}&year=${year}`);
                const data = await response.json();

                const content = document.getElementById('monthlyReportContent');

                content.innerHTML = `
                    <div class="stat-grid" style="margin-top: 16px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Payments</div>
                            <div class="stat-value">${data.totalPayments}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Amount</div>
                            <div class="stat-value">‚Çπ${data.totalAmount.toLocaleString('en-IN')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Debt Paid</div>
                            <div class="stat-value">‚Çπ${data.debtPaid.toLocaleString('en-IN')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Salary</div>
                            <div class="stat-value">‚Çπ${data.totalSalary.toLocaleString('en-IN')}</div>
                        </div>
                    </div>
                    <div class="section-title" style="margin-top: 16px;">Individual Salaries</div>
                    <div class="partner-grid">
                        <div class="partner-card">
                            <span class="partner-name">Partner A</span>
                            <span class="partner-amount">‚Çπ${data.salaries.A.toLocaleString('en-IN')}</span>
                        </div>
                        <div class="partner-card">
                            <span class="partner-name">Partner B</span>
                            <span class="partner-amount">‚Çπ${data.salaries.B.toLocaleString('en-IN')}</span>
                        </div>
                        <div class="partner-card">
                            <span class="partner-name">Partner C</span>
                            <span class="partner-amount">‚Çπ${data.salaries.C.toLocaleString('en-IN')}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                showAlert('Failed to load monthly report', 'error');
            }
        }

        function togglePendingApprovals() {
            const section = document.getElementById('pendingApprovalsSection');
            section.classList.toggle('hidden');

            if (!section.classList.contains('hidden')) {
                loadPendingApprovals();
            }
        }

        async function loadPendingApprovals() {
            try {
                const response = await fetch(`${API_URL}/api/access/pending?telegramId=${telegramId}`);
                const data = await response.json();

                const list = document.getElementById('pendingApprovalsList');

                if (data.pending.length === 0) {
                    list.innerHTML = '<p style="text-align:center;color:#999;">No pending requests</p>';
                    return;
                }

                list.innerHTML = data.pending.map(user => `
                    <div class="pending-item">
                        <div class="pending-info">
                            <div style="font-weight:600;">${user.userName}</div>
                            <div style="font-size:12px;color:#999;">ID: ${user.telegramId}</div>
                        </div>
                        <div class="pending-actions">
                            <button class="btn btn-success btn-small" onclick="approveUser('${user.telegramId}')">‚úÖ</button>
                            <button class="btn btn-danger btn-small" onclick="rejectUser('${user.telegramId}')">‚ùå</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showAlert('Failed to load pending approvals', 'error');
            }
        }

        async function approveUser(userId) {
            try {
                const response = await fetch(`${API_URL}/api/access/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId, userId })
                });

                if (response.ok) {
                    showAlert('User approved!', 'success');
                    loadPendingApprovals();
                } else {
                    showAlert('Failed to approve user', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        async function rejectUser(userId) {
            try {
                const response = await fetch(`${API_URL}/api/access/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId, userId })
                });

                if (response.ok) {
                    showAlert('User rejected!', 'success');
                    loadPendingApprovals();
                } else {
                    showAlert('Failed to reject user', 'error');
                }
            } catch (error) {
                showAlert('Network error', 'error');
            }
        }

        async function exportData() {
            if (!isAdmin) {
                showAlert('‚õî Admin access required', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/export?telegramId=${telegramId}`);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `partnership-backup-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showAlert('‚úÖ Data exported successfully!', 'success');
                } else {
                    showAlert('‚ùå Export failed', 'error');
                }
            } catch (error) {
                showAlert('‚ùå Network error', 'error');
            }
        }

        async function importData() {
            if (!isAdmin) {
                showAlert('‚õî Admin access required', 'error');
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    const replaceExisting = confirm(
                        '‚ö†Ô∏è IMPORT OPTIONS:\n\n' +
                        'OK = Replace all existing data\n' +
                        'Cancel = Merge with existing data\n\n' +
                        'Choose wisely!'
                    );

                    const response = await fetch(`${API_URL}/api/import`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            telegramId, 
                            data, 
                            replaceExisting 
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showAlert(`‚úÖ Imported: ${result.imported.payments} payments, ${result.imported.users} users`, 'success');
                        await loadState();
                        await loadHistory();
                    } else {
                        const error = await response.json();
                        showAlert('‚ùå Import failed: ' + error.error, 'error');
                    }
                } catch (error) {
                    showAlert('‚ùå Invalid backup file', 'error');
                }
            };

            input.click();
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            container.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
