<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partnership Calculator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .debt-summary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .debt-amount {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(17,153,142,0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245,87,108,0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .partners-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .partner-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .partner-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .partner-details {
            font-size: 14px;
            opacity: 0.9;
            margin: 5px 0;
        }

        .debt-status {
            margin-top: 20px;
        }

        .debt-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .debt-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .debt-item-name {
            font-weight: bold;
            font-size: 18px;
        }

        .debt-item-details {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }

        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #11998e;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-amount {
            font-size: 24px;
            font-weight: bold;
            color: #11998e;
        }

        .history-date {
            font-size: 12px;
            color: #999;
        }

        .history-details {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }

        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        /* ========== BLOCK 1 ADDED: Partner Management Styles ========== */
        .partner-config-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
        }

        .partner-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .partner-id-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
        }

        .btn-remove-partner {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        /* ========== END BLOCK 1 ========== */

        @media (max-width: 600px) {
            .partners-grid, .admin-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üíº Partnership Calculator</h1>
            <p id="userInfo"></p>
        </div>

        <!-- Admin Login Section -->
        <div id="adminLoginSection" class="card hidden">
            <div class="section-title">üîë Admin Setup</div>
            <p style="margin-bottom: 20px; color: #666;">Set up admin access with password</p>
            <div class="form-group">
                <input type="password" id="adminPassword" class="form-input" placeholder="Enter admin password">
            </div>
            <button class="btn btn-primary" onclick="adminLogin()">Set as Admin</button>
        </div>

        <!-- Access Denied Section -->
        <div id="accessDeniedSection" class="card hidden">
            <div class="section-title">üîê Access Required</div>
            <p id="accessMessage" style="margin: 20px 0; text-align: center;">Requesting access...</p>
            <button class="btn btn-primary" onclick="requestAccess()">Request Access</button>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Main App -->
        <div id="app" class="hidden">
            <!-- Debt Summary -->
            <div class="card">
                <div class="debt-summary">
                    <div class="section-title" style="color: white; justify-content: center;">‚ö†Ô∏è Total Remaining Debt for Person X</div>
                    <div class="debt-amount" id="remainingDebt">‚Çπ0</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Debt Paid to X</div>
                            <div class="stat-value" id="totalDebtPaid">‚Çπ0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Salary Paid</div>
                            <div class="stat-value" id="totalSalaryPaid">‚Çπ0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Extra Payments</div>
                            <div class="stat-value" id="totalExtraPayments">‚Çπ0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Report Button -->
            <div class="card">
                <button class="btn btn-secondary" onclick="toggleMonthlyReport()">üìÖ Monthly Salary Report</button>
            </div>

            <!-- Monthly Report Section -->
            <div id="monthlyReportSection" class="card hidden">
                <div class="section-title">üìÖ Monthly Salary Report</div>
                <div class="form-group">
                    <label class="form-label">Select Month</label>
                    <select id="monthSelect" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Select Year</label>
                    <select id="yearSelect" class="form-select"></select>
                </div>
                <button class="btn btn-primary" onclick="generateMonthlyReport()">Generate Report</button>
                <div id="monthlyReportContent" class="hidden" style="margin-top: 20px;"></div>
            </div>

            <!-- Payment Form -->
            <div id="paymentFormSection" class="card hidden">
                <form id="paymentForm">
                    <div class="section-title">üí∞ Enter Payment Amount (‚Çπ)</div>
                    <div class="form-group">
                        <input type="number" id="paymentAmount" class="form-input" placeholder="Enter amount" step="0.01" required>
                        <small style="color: #999;">50/50 Split</small>
                    </div>

                    <div class="section-title">üìÖ Payment Period (Optional)</div>
                    <div class="form-group">
                        <label class="form-label">From Date</label>
                        <input type="date" id="paymentStartDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To Date</label>
                        <input type="date" id="paymentEndDate" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">üí¨ Comment/Remark (Optional)</label>
                        <textarea id="paymentComment" class="form-textarea" placeholder="Add a note about this payment..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-success">Submit Payment</button>
                    <div id="previewSection" class="hidden" style="margin-top: 20px;"></div>
                </form>
            </div>

            <!-- Extra Payment Section -->
            <div id="extraPaymentSection" class="card hidden">
                <div class="section-title">üí≥ Extra Payment (Reduces Partner's Debt)</div>
                <div class="form-group">
                    <label class="form-label">Select Partner</label>
                    <select id="extraPartner" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (‚Çπ)</label>
                    <input type="number" id="extraAmount" class="form-input" placeholder="Enter extra payment amount" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">üí¨ Comment/Remark (Optional)</label>
                    <textarea id="extraComment" class="form-textarea" placeholder="Reason for extra payment..."></textarea>
                </div>
                <button class="btn btn-warning" onclick="submitExtraPayment()">Submit Extra Payment</button>
            </div>

            <!-- New Debt Section -->
            <div id="newDebtSection" class="card hidden">
                <div class="section-title">üÜï Add New Debt (Separate from Initial Debt)</div>
                <div class="form-group">
                    <label class="form-label">Select Partner</label>
                    <select id="debtPartner" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Debt Amount (‚Çπ)</label>
                    <input type="number" id="debtAmount" class="form-input" placeholder="Enter new debt amount" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">üí¨ Comment/Remark (Optional)</label>
                    <textarea id="debtComment" class="form-textarea" placeholder="Reason for new debt..."></textarea>
                </div>
                <button class="btn btn-danger" onclick="submitNewDebt()">Add New Debt</button>
            </div>

            <!-- ========== BLOCK 3 ADDED: Partner Configuration Sections ========== -->
            <!-- Partner Configuration Section -->
            <div id="partnerConfigSection" class="card hidden">
                <div class="section-title">üë• Manage Partners</div>
                <div id="shareTotal" style="text-align:center;padding:15px;border-radius:10px;margin:15px 0;font-weight:bold;font-size:18px;background:#d4edda;color:#155724;">
                    Total Share: 100%
                </div>
                <div id="partnerConfigList"></div>
                <button class="btn btn-success" onclick="showAddPartnerForm()">‚ûï Add New Partner</button>
                <button class="btn btn-primary" onclick="savePartnerConfig()">üíæ Save Changes</button>
                <button class="btn btn-secondary" onclick="togglePartnerConfig()">‚ùå Cancel</button>
            </div>

            <!-- Add Partner Form -->
            <div id="addPartnerForm" class="card hidden">
                <div class="section-title">‚ûï Add New Partner</div>
                <div class="form-group">
                    <label class="form-label">Partner ID (e.g., D, E, F)</label>
                    <input type="text" id="newPartnerId" class="form-input" maxlength="5" placeholder="Enter partner ID">
                </div>
                <div class="form-group">
                    <label class="form-label">Partner Name</label>
                    <input type="text" id="newPartnerName" class="form-input" placeholder="Enter partner name">
                </div>
                <div class="form-group">
                    <label class="form-label">Initial Debt (‚Çπ)</label>
                    <input type="number" id="newPartnerDebt" class="form-input" placeholder="0" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Share (%)</label>
                    <input type="number" id="newPartnerShare" class="form-input" step="0.01" placeholder="0">
                    <small style="color:#999;">Total must equal 100%</small>
                </div>
                <button class="btn btn-success" onclick="addPartner()">‚úÖ Add Partner</button>
                <button class="btn btn-secondary" onclick="cancelAddPartner()">‚ùå Cancel</button>
            </div>
            <!-- ========== END BLOCK 3 ========== -->

            <!-- Partners Distribution -->
            <div class="card">
                <div class="section-title">üë• Partner Distribution</div>
                <div class="partners-grid" id="partnersGrid"></div>
            </div>

            <!-- Debt Status -->
            <div class="card">
                <div class="section-title">üí∞ Debt Status</div>
                <div class="debt-status" id="debtStatus"></div>
            </div>

            <!-- Payment History -->
            <div class="card" id="historySection">
                <div class="section-title">üìÖ Payment History</div>
                <div id="historyContent"></div>
            </div>

            <!-- Admin Controls -->
            <div id="adminControls" class="card hidden">
                <div class="section-title">‚öôÔ∏è Admin Controls</div>
                <div class="admin-actions">
                    <button class="btn btn-success" onclick="togglePaymentForm()">üí∞ Record Payment</button>
                    <button class="btn btn-warning" onclick="toggleExtraPayment()">üí≥ Extra Payment</button>
                    <button class="btn btn-danger" onclick="toggleNewDebt()">üÜï Add New Debt</button>
                    <!-- ========== BLOCK 2 ADDED: New Feature Buttons ========== -->
                    <button class="btn btn-primary" onclick="togglePartnerConfig()">üë• Manage Partners</button>
                    <button class="btn btn-success" onclick="exportData()">üì§ Export Backup</button>
                    <button class="btn btn-warning" onclick="importData()">üì• Import Backup</button>
                    <!-- ========== END BLOCK 2 ========== -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const API_URL = window.location.origin;
        let telegramId = null;
        let userName = 'User';
        let isAdmin = false;
        let partners = {};
        let currentState = {};

        async function init() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                telegramId = tg.initDataUnsafe.user.id;
                userName = tg.initDataUnsafe.user.first_name || 'User';
            } else {
                telegramId = 'demo_' + Date.now();
                userName = 'Demo User';
            }

            document.getElementById('userInfo').textContent = `Welcome, ${userName}!`;
            await checkAdminStatus();
            populateMonthYearSelects();
        }

        async function checkAdminStatus() {
            try {
                const response = await fetch(`${API_URL}/api/admin/check?telegramId=${telegramId}`);
                const data = await response.json();

                if (!data.hasAdmin) {
                    showSection('adminLoginSection');
                } else if (data.isAdmin) {
                    isAdmin = true;
                    showSection('app');
                    document.getElementById('adminControls').classList.remove('hidden');
                    await loadState();
                } else if (data.isApproved) {
                    showSection('app');
                    await loadState();
                } else {
                    showSection('accessDeniedSection');
                }
            } catch (error) {
                showAlert('Network error. Please check your connection.', 'danger');
            }
        }

        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (!password) {
                showAlert('Please enter password', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, telegramId })
                });

                if (response.ok) {
                    isAdmin = true;
                    showSection('app');
                    document.getElementById('adminControls').classList.remove('hidden');
                    await loadState();
                    showAlert('Admin access granted!', 'success');
                } else {
                    showAlert('Invalid password', 'danger');
                }
            } catch (error) {
                showAlert('Network error', 'danger');
            }
        }

        async function requestAccess() {
            try {
                const response = await fetch(`${API_URL}/api/access/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId, userName })
                });

                const data = await response.json();
                if (data.approved) {
                    showSection('app');
                    await loadState();
                } else {
                    document.getElementById('accessMessage').textContent = 'Request sent! Waiting for admin approval...';
                    showAlert('Access request sent to admin', 'info');
                }
            } catch (error) {
                showAlert('Network error', 'danger');
            }
        }

        async function loadState() {
            try {
                const response = await fetch(`${API_URL}/api/state?telegramId=${telegramId}`);
                const data = await response.json();

                currentState = data;
                partners = data.partners || {};

                document.getElementById('remainingDebt').textContent = '‚Çπ' + formatNumber(data.remainingDebt);
                document.getElementById('totalDebtPaid').textContent = '‚Çπ' + formatNumber(data.totalDebtPaid);
                document.getElementById('totalSalaryPaid').textContent = '‚Çπ' + formatNumber(data.totalSalaryPaid);
                document.getElementById('totalExtraPayments').textContent = '‚Çπ' + formatNumber(data.totalExtraPayments);

                updatePartnersDisplay();
                updateDebtStatus(data);
                await loadHistory();
                updatePartnerSelects();
            } catch (error) {
                showAlert('Failed to load data', 'danger');
            }
        }

        function updatePartnersDisplay() {
            const grid = document.getElementById('partnersGrid');
            grid.innerHTML = Object.keys(partners).map(key => {
                const partner = partners[key];
                const debtPaid = currentState.debtPaid ? currentState.debtPaid[key] || 0 : 0;
                const salaryReceived = calculatePartnerSalary(key);

                return `
                    <div class="partner-card">
                        <div class="partner-name">üë§ ${partner.name} (${key})</div>
                        <div class="partner-details">${(partner.share * 100).toFixed(0)}%</div>
                        <div class="partner-details">Share Amount: ‚Çπ<span id="share_${key}">0</span></div>
                        <div class="partner-details">Debt Payment: ‚Çπ${formatNumber(debtPaid)}</div>
                        <div class="partner-details">Salary Received: ‚Çπ${formatNumber(salaryReceived)}</div>
                    </div>
                `;
            }).join('');
        }

        function updateDebtStatus(data) {
            const container = document.getElementById('debtStatus');
            container.innerHTML = Object.keys(partners).map(key => {
                const partner = partners[key];
                const debtPaid = data.debtPaid ? data.debtPaid[key] || 0 : 0;
                const extraPaid = data.extraPayments ? data.extraPayments[key] || 0 : 0;
                const remaining = Math.max(0, partner.debt - debtPaid - extraPaid);

                return `
                    <div class="debt-item">
                        <div class="debt-item-header">
                            <div class="debt-item-name">üë§ ${partner.name} (${key})</div>
                        </div>
                        <div class="debt-item-details">Initial Debt: ‚Çπ${formatNumber(partner.debt)}</div>
                        <div class="debt-item-details">Paid (Regular): ‚Çπ${formatNumber(debtPaid)}</div>
                        <div class="debt-item-details">Extra Paid: ‚Çπ${formatNumber(extraPaid)}</div>
                        <div class="debt-item-details" style="color: #f5576c; font-weight: bold;">Remaining: ‚Çπ${formatNumber(remaining)}</div>
                    </div>
                `;
            }).join('');
        }

        function calculatePartnerSalary(partnerId) {
            if (!currentState.payments) return 0;
            return currentState.payments
                .filter(p => p.type === 'regular' && p.partnerDetails && p.partnerDetails[partnerId])
                .reduce((sum, p) => sum + (p.partnerDetails[partnerId].salary || 0), 0);
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/api/history?telegramId=${telegramId}&limit=50`);
                const data = await response.json();

                const container = document.getElementById('historyContent');

                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999;">No payment history yet</p>';
                    return;
                }

                container.innerHTML = data.history.map(payment => {
                    const date = new Date(payment.timestamp).toLocaleDateString('en-IN', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    let html = `<div class="history-item">
                        <div class="history-header">
                            <div class="history-amount">‚Çπ${formatNumber(Math.abs(payment.amount))}</div>
                            <div class="history-date">${date}</div>
                        </div>`;

                    if (payment.type === 'extra') {
                        const partnerName = partners[payment.partner]?.name || payment.partner;
                        const label = payment.amount < 0 ? 'New Debt' : 'Extra Payment';
                        html += `<div class="history-details">${partnerName} - ${label}</div>`;
                    } else {
                        html += `<div class="history-details">To Person X: ‚Çπ${formatNumber(payment.toPersonX)}</div>`;
                        html += `<div class="history-details">To Salary: ‚Çπ${formatNumber(payment.toSalary)}</div>`;
                    }

                    if (payment.comment) {
                        html += `<div class="history-details" style="font-style: italic;">üí¨ ${payment.comment}</div>`;
                    }

                    if (payment.paymentStartDate && payment.paymentEndDate) {
                        const startDate = new Date(payment.paymentStartDate).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                        const endDate = new Date(payment.paymentEndDate).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                        html += `<div class="history-details">üìÖ Period: ${startDate} - ${endDate}</div>`;
                    }

                    html += `</div>`;
                    return html;
                }).join('');
            } catch (error) {
                document.getElementById('historyContent').innerHTML = '<p style="text-align: center; color: #f5576c;">Failed to load history</p>';
            }
        }

        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const comment = document.getElementById('paymentComment').value;
            const startDate = document.getElementById('paymentStartDate').value;
            const endDate = document.getElementById('paymentEndDate').value;

            if (!amount || amount <= 0) {
                showAlert('Please enter a valid amount', 'danger');
                return;
            }

            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                showAlert('Start date must be before end date', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount,
                        recordedBy: userName,
                        telegramId,
                        comment,
                        paymentStartDate: startDate || null,
                        paymentEndDate: endDate || null
                    })
                });

                if (response.ok) {
                    showAlert('Payment recorded successfully!', 'success');
                    document.getElementById('paymentForm').reset();
                    togglePaymentForm();
                    await loadState();
                } else {
                    showAlert('Failed to record payment', 'danger');
                }
            } catch (error) {
                showAlert('Network error', 'danger');
            }
        });

        document.getElementById('paymentAmount').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value);
            if (amount && amount > 0) {
                updatePaymentPreview(amount);
            } else {
                document.getElementById('previewSection').classList.add('hidden');
            }
        });

        function updatePaymentPreview(amount) {
            const preview = document.getElementById('previewSection');
            preview.classList.remove('hidden');

            let html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">';
            html += '<div style="font-weight: bold; margin-bottom: 10px;">üí° Payment Preview</div>';

            Object.keys(partners).forEach(key => {
                const partner = partners[key];
                const share = amount * partner.share;
                html += `<div style="margin: 5px 0;">${partner.name}: ‚Çπ${formatNumber(share)}</div>`;
                const shareElem = document.getElementById(`share_${key}`);
                if (shareElem) shareElem.textContent = formatNumber(share);
            });

            html += '</div>';
            preview.innerHTML = html;
        }

        async function submitExtraPayment() {
            const partner = document.getElementById('extraPartner').value;
            const amount = parseFloat(document.getElementById('extraAmount').value);
            const comment = document.getElementById('extraComment').value;

            if (!amount || amount <= 0) {
                showAlert('Please enter a valid amount', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/extra-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partner, amount, recordedBy: userName, telegramId, comment })
                });

                if (response.ok) {
                    showAlert('Extra payment recorded!', 'success');
                    document.getElementById('extraAmount').value = '';
                    document.getElementById('extraComment').value = '';
                    toggleExtraPayment();
                    await loadState();
                } else {
                    showAlert('Failed to record extra payment', 'danger');
                }
            } catch (error) {
                showAlert('Network error', 'danger');
            }
        }

        async function submitNewDebt() {
            const partner = document.getElementById('debtPartner').value;
            const amount = parseFloat(document.getElementById('debtAmount').value);
            const comment = document.getElementById('debtComment').value;

            if (!amount || amount <= 0) {
                showAlert('Please enter a valid debt amount', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/extra-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partner, amount: -amount, recordedBy: userName, telegramId, comment })
                });

                if (response.ok) {
                    showAlert('New debt added!', 'success');
                    document.getElementById('debtAmount').value = '';
                    document.getElementById('debtComment').value = '';
                    toggleNewDebt();
                    await loadState();
                } else {
                    showAlert('Failed to add debt', 'danger');
                }
            } catch (error) {
                showAlert('Network error', 'danger');
            }
        }

        function populateMonthYearSelects() {
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');

            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];

            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = month;
                if (index === currentMonth) option.selected = true;
                monthSelect.appendChild(option);
            });

            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        async function generateMonthlyReport() {
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;

            try {
                const response = await fetch(`${API_URL}/api/monthly?telegramId=${telegramId}&month=${month}&year=${year}`);
                const data = await response.json();

                const content = document.getElementById('monthlyReportContent');
                content.classList.remove('hidden');

                let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">';
                html += `<h3 style="margin-bottom: 15px;">üìä Report for ${getMonthName(month)} ${year}</h3>`;
                html += `<div style="margin: 10px 0;"><strong>Total Payments:</strong> ${data.totalPayments}</div>`;
                html += `<div style="margin: 10px 0;"><strong>Total Amount:</strong> ‚Çπ${formatNumber(data.totalAmount)}</div>`;
                html += `<div style="margin: 10px 0;"><strong>Debt Paid:</strong> ‚Çπ${formatNumber(data.debtPaid)}</div>`;
                html += `<div style="margin: 10px 0;"><strong>Total Salary:</strong> ‚Çπ${formatNumber(data.totalSalary)}</div>`;

                html += '<h4 style="margin-top: 20px; margin-bottom: 10px;">Partner Salaries:</h4>';
                Object.keys(partners).forEach(key => {
                    const salary = data.salaries[key] || 0;
                    html += `<div style="margin: 5px 0;">${partners[key].name} (${key}): ‚Çπ${formatNumber(salary)}</div>`;
                });

                html += '</div>';
                content.innerHTML = html;
            } catch (error) {
                showAlert('Failed to generate report', 'danger');
            }
        }

        function getMonthName(month) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            return months[parseInt(month) - 1];
        }

        function updatePartnerSelects() {
            const extraSelect = document.getElementById('extraPartner');
            const debtSelect = document.getElementById('debtPartner');

            [extraSelect, debtSelect].forEach(select => {
                select.innerHTML = Object.keys(partners).map(key => 
                    `<option value="${key}">${partners[key].name} (${key})</option>`
                ).join('');
            });
        }

        function togglePaymentForm() {
            document.getElementById('paymentFormSection').classList.toggle('hidden');
        }

        function toggleExtraPayment() {
            document.getElementById('extraPaymentSection').classList.toggle('hidden');
        }

        function toggleNewDebt() {
            document.getElementById('newDebtSection').classList.toggle('hidden');
        }

        function toggleMonthlyReport() {
            document.getElementById('monthlyReportSection').classList.toggle('hidden');
        }

        function showSection(sectionId) {
            ['adminLoginSection', 'accessDeniedSection', 'app'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;

            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function formatNumber(num) {
            return Math.round(num).toLocaleString('en-IN');
        }

        // ========== BLOCK 4 ADDED: New Feature Functions ==========

        function togglePartnerConfig() {
            const section = document.getElementById('partnerConfigSection');
            section.classList.toggle('hidden');
            if (!section.classList.contains('hidden')) {
                renderPartnerConfig();
            }
        }

        function renderPartnerConfig() {
            const list = document.getElementById('partnerConfigList');
            list.innerHTML = Object.keys(partners).map(key => {
                const partner = partners[key];
                return `
                    <div class="partner-config-item">
                        <div class="partner-config-header">
                            <div class="partner-id-badge">${key}</div>
                            <button class="btn-remove-partner" onclick="removePartner('${key}')">Remove</button>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-input" id="partner_name_${key}" value="${partner.name}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Initial Debt (‚Çπ)</label>
                            <input type="number" class="form-input" id="partner_debt_${key}" value="${partner.debt}" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Share (%)</label>
                            <input type="number" class="form-input partner-share-input" id="partner_share_${key}" value="${(partner.share * 100).toFixed(2)}" step="0.01" onchange="updateShareTotal()">
                        </div>
                    </div>
                `;
            }).join('');
            updateShareTotal();
        }

        function updateShareTotal() {
            let total = 0;
            document.querySelectorAll('.partner-share-input').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            const indicator = document.getElementById('shareTotal');
            indicator.textContent = `Total Share: ${total.toFixed(2)}%`;
            if (Math.abs(total - 100) < 0.01) {
                indicator.style.background = '#d4edda';
                indicator.style.color = '#155724';
            } else {
                indicator.style.background = '#f8d7da';
                indicator.style.color = '#721c24';
            }
        }

        function showAddPartnerForm() {
            document.getElementById('addPartnerForm').classList.remove('hidden');
        }

        function cancelAddPartner() {
            document.getElementById('addPartnerForm').classList.add('hidden');
            document.getElementById('newPartnerId').value = '';
            document.getElementById('newPartnerName').value = '';
            document.getElementById('newPartnerDebt').value = '';
            document.getElementById('newPartnerShare').value = '';
        }

        function addPartner() {
            const id = document.getElementById('newPartnerId').value.trim().toUpperCase();
            const name = document.getElementById('newPartnerName').value.trim();
            const debt = parseFloat(document.getElementById('newPartnerDebt').value) || 0;
            const share = parseFloat(document.getElementById('newPartnerShare').value) / 100 || 0;
            if (!id || !name) {
                showAlert('Please enter partner ID and name', 'danger');
                return;
            }
            if (partners[id]) {
                showAlert('Partner ID already exists', 'danger');
                return;
            }
            partners[id] = { name, debt, share };
            renderPartnerConfig();
            cancelAddPartner();
            showAlert('Partner added! Remember to save changes', 'info');
        }

        function removePartner(key) {
            if (!confirm(`Remove partner ${partners[key].name}?`)) return;
            delete partners[key];
            renderPartnerConfig();
            showAlert('Partner removed! Remember to save changes', 'info');
        }

        async function savePartnerConfig() {
            const updatedPartners = {};
            let totalShare = 0;
            for (const key of Object.keys(partners)) {
                const name = document.getElementById(`partner_name_${key}`)?.value;
                const debt = parseFloat(document.getElementById(`partner_debt_${key}`)?.value) || 0;
                const share = parseFloat(document.getElementById(`partner_share_${key}`)?.value) / 100 || 0;
                updatedPartners[key] = { name, debt, share };
                totalShare += share;
            }
            if (Math.abs(totalShare - 1.0) > 0.01) {
                showAlert(`Total share must be 100%! Current: ${(totalShare * 100).toFixed(1)}%`, 'danger');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/api/config/partners`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partners: updatedPartners, telegramId })
                });
                if (response.ok) {
                    showAlert('Partners configuration saved!', 'success');
                    await loadState();
                    togglePartnerConfig();
                } else {
                    const error = await response.json();
                    showAlert('Failed: ' + error.error, 'danger');
                }
            } catch (error) {
                showAlert('Network error', 'danger');
            }
        }

        async function exportData() {
            if (!isAdmin) {
                showAlert('Admin access required', 'danger');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/api/export?telegramId=${telegramId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `partnership-backup-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showAlert('‚úÖ Data exported successfully!', 'success');
                } else {
                    showAlert('Export failed', 'danger');
                }
            } catch (error) {
                showAlert('Network error', 'danger');
            }
        }

        async function importData() {
            if (!isAdmin) {
                showAlert('Admin access required', 'danger');
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    const confirmed = confirm(
                        '‚ö†Ô∏è IMPORT WARNING:\n\n' +
                        'This will replace ALL current data.\n\n' +
                        'Partners: ' + Object.keys(data.partners || {}).length + '\n' +
                        'Payments: ' + (data.state?.payments?.length || 0) + '\n\n' +
                        'Continue?'
                    );
                    if (!confirmed) return;
                    const response = await fetch(`${API_URL}/api/import`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ telegramId, data })
                    });
                    if (response.ok) {
                        const result = await response.json();
                        showAlert(`‚úÖ Imported: ${result.imported.partners} partners, ${result.imported.payments} payments`, 'success');
                        await loadState();
                    } else {
                        const error = await response.json();
                        showAlert('Import failed: ' + error.error, 'danger');
                    }
                } catch (error) {
                    showAlert('Invalid backup file: ' + error.message, 'danger');
                }
            };
            input.click();
        }

        // ========== END BLOCK 4 ==========

        init();
    </script>
</body>
</html>